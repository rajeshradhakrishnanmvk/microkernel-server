<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Digital Billboard Manager - SLOP Architecture</title>

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
    color: #eaeaea;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    padding: 20px;
    min-height: 100vh;
  }

  .header {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    padding: 20px 30px;
    border-radius: 12px;
    margin-bottom: 20px;
    border: 1px solid #00ff66;
    box-shadow: 0 4px 20px rgba(0, 255, 102, 0.1);
  }

  .header h1 {
    font-size: 28px;
    margin-bottom: 10px;
    color: #00ff66;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .header-subtitle {
    font-size: 14px;
    color: #888;
    font-family: monospace;
  }

  .system-status {
    display: flex;
    gap: 20px;
    margin-top: 15px;
    flex-wrap: wrap;
  }

  .status-chip {
    background: rgba(0, 255, 102, 0.1);
    border: 1px solid #00ff66;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #00ff66;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .container {
    max-width: 1600px;
    margin: 0 auto;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }

  .panel {
    background: #16213e;
    border-radius: 12px;
    padding: 20px;
    border: 1px solid #2a3f5f;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }

  .panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid #00ff66;
  }

  .panel-title {
    font-size: 18px;
    font-weight: 600;
    color: #00ff66;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .btn {
    background: linear-gradient(135deg, #00ff66 0%, #00cc52 100%);
    color: #000;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 13px;
    transition: all 0.3s;
    box-shadow: 0 2px 10px rgba(0, 255, 102, 0.3);
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0, 255, 102, 0.5);
  }

  .btn-secondary {
    background: #1a1a2e;
    color: #00ff66;
    border: 1px solid #00ff66;
  }

  .btn-danger {
    background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
    color: #fff;
  }

  .btn-small {
    padding: 6px 12px;
    font-size: 11px;
  }

  input[type="text"],
  input[type="number"],
  select,
  textarea {
    width: 100%;
    background: #0a0a0a;
    color: #00ff66;
    border: 1px solid #2a3f5f;
    padding: 10px;
    border-radius: 6px;
    font-family: 'Segoe UI', sans-serif;
    font-size: 13px;
    margin-bottom: 12px;
    transition: border-color 0.3s;
  }

  input:focus,
  select:focus,
  textarea:focus {
    outline: none;
    border-color: #00ff66;
    box-shadow: 0 0 10px rgba(0, 255, 102, 0.2);
  }

  textarea {
    min-height: 80px;
    resize: vertical;
    font-family: monospace;
  }

  label {
    display: block;
    font-size: 12px;
    color: #888;
    text-transform: uppercase;
    margin-bottom: 6px;
    font-weight: 600;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .billboard-card {
    background: #0a0a0a;
    border: 1px solid #2a3f5f;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    transition: all 0.3s;
  }

  .billboard-card:hover {
    border-color: #00ff66;
    box-shadow: 0 4px 20px rgba(0, 255, 102, 0.2);
  }

  .billboard-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .billboard-title {
    font-size: 16px;
    font-weight: 600;
    color: #00ff66;
  }

  .billboard-preview {
    background: #000;
    padding: 20px;
    border-radius: 6px;
    text-align: center;
    margin: 12px 0;
    min-height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    position: relative;
  }

  .billboard-preview-text {
    font-size: 24px;
    font-weight: 900;
    text-transform: uppercase;
    line-height: 1.2;
    white-space: pre-line;
  }

  .billboard-preview-image {
    max-width: 80%;
    max-height: 150px;
    margin-bottom: 12px;
    border-radius: 6px;
  }

  .plugin-card {
    background: #0a0a0a;
    border: 1px solid #2a3f5f;
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s;
  }

  .plugin-card.active {
    border-color: #00ff66;
    background: rgba(0, 255, 102, 0.05);
  }

  .plugin-card.error {
    border-color: #ff4444;
  }

  .plugin-info {
    flex: 1;
  }

  .plugin-name {
    font-size: 15px;
    font-weight: 600;
    color: #00ff66;
    margin-bottom: 4px;
  }

  .plugin-desc {
    font-size: 12px;
    color: #888;
  }

  .plugin-status {
    font-size: 11px;
    color: #666;
    margin-top: 6px;
  }

  .plugin-status.active {
    color: #00ff66;
  }

  .plugin-status.error {
    color: #ff4444;
  }

  .log-container {
    background: #000;
    border-radius: 6px;
    padding: 12px;
    max-height: 400px;
    overflow-y: auto;
    font-family: 'Courier New', monospace;
    font-size: 11px;
  }

  .log-entry {
    padding: 6px;
    border-left: 3px solid #333;
    margin-bottom: 4px;
    display: flex;
    gap: 8px;
  }

  .log-entry.INFO {
    border-left-color: #0099ff;
  }

  .log-entry.SUCCESS {
    border-left-color: #00ff66;
  }

  .log-entry.WARN {
    border-left-color: #ffaa00;
  }

  .log-entry.ERROR {
    border-left-color: #ff4444;
  }

  .log-time {
    color: #666;
  }

  .log-level {
    font-weight: 600;
    min-width: 60px;
  }

  .log-message {
    color: #ccc;
  }

  .tab-container {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    border-bottom: 2px solid #2a3f5f;
  }

  .tab {
    padding: 12px 24px;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.3s;
    font-weight: 600;
    color: #888;
  }

  .tab:hover {
    color: #00ff66;
  }

  .tab.active {
    color: #00ff66;
    border-bottom-color: #00ff66;
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  .color-picker-group {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .color-preview {
    width: 40px;
    height: 40px;
    border-radius: 6px;
    border: 2px solid #2a3f5f;
  }

  input[type="color"] {
    width: 60px;
    height: 40px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }

  .quick-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .badge {
    background: rgba(0, 255, 102, 0.2);
    color: #00ff66;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
  }

  .badge-danger {
    background: rgba(255, 68, 68, 0.2);
    color: #ff4444;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
    margin-top: 12px;
  }

  .stat-card {
    background: #0a0a0a;
    padding: 12px;
    border-radius: 6px;
    border: 1px solid #2a3f5f;
    text-align: center;
  }

  .stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #00ff66;
  }

  .stat-label {
    font-size: 11px;
    color: #888;
    margin-top: 4px;
  }

  .empty-state {
    text-align: center;
    padding: 40px;
    color: #666;
  }

  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 12px;
  }

  .loading {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 3px solid #2a3f5f;
    border-top-color: #00ff66;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #16213e;
    border: 1px solid #00ff66;
    padding: 16px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    z-index: 1000;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from {
      transform: translateX(400px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
</style>
</head>

<body>

<div class="container">
  <!-- Header -->
  <div class="header">
    <h1>
      üéØ Digital Billboard Manager
    </h1>
    <div class="header-subtitle">SLOP Architecture | Microkernel-based Plugin System</div>
    
    <div class="system-status">
      <div class="status-chip">
        <div class="status-dot"></div>
        <span id="kernelStatus">Kernel Active</span>
      </div>
      <div class="status-chip">
        <span id="pluginCount">0 Plugins</span>
      </div>
      <div class="status-chip">
        <span id="billboardCount">0 Billboards</span>
      </div>
      <button class="btn btn-secondary btn-small" onclick="window.open('/display', '_blank')">
        üì∫ Open Display
      </button>
    </div>
  </div>

  <!-- Main Tabs -->
  <div class="tab-container">
    <div class="tab active" onclick="switchTab('billboards')">üìä Billboards</div>
    <div class="tab" onclick="switchTab('create')">‚ûï Create</div>
    <div class="tab" onclick="switchTab('plugins')">üîå Plugins</div>
    <div class="tab" onclick="switchTab('logs')">üìù Logs & Reports</div>
  </div>

  <!-- Billboards Tab -->
  <div id="tab-billboards" class="tab-content active">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Active Billboards</div>
        <button class="btn btn-small" onclick="refreshBillboards()">‚ü≤ Refresh</button>
      </div>
      
      <div id="billboardsList">
        <div class="empty-state">
          <div class="empty-state-icon">üì∫</div>
          <div>No billboards yet. Create one in the "Create" tab!</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Tab -->
  <div id="tab-create" class="tab-content">
    <div class="grid">
      <!-- Quick Create Panel -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">üöÄ Quick Create</div>
        </div>
        
        <div class="form-group">
          <label>Theme</label>
          <select id="quickTheme">
            <option value="food">Food & Restaurant</option>
            <option value="tech">Technology</option>
            <option value="retail" selected>Retail & Shopping</option>
            <option value="service">Services</option>
            <option value="event">Events</option>
          </select>
        </div>

        <div class="form-group">
          <label>Keywords (optional, comma-separated)</label>
          <input type="text" id="quickKeywords" placeholder="e.g., SALE, 50% OFF, TODAY">
        </div>

        <button class="btn" style="width: 100%;" onclick="quickCreateBillboard()">
          ‚ú® Generate Billboard with AI Message
        </button>
      </div>

      <!-- Custom Create Panel -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">‚öôÔ∏è Custom Billboard</div>
        </div>
        
        <div class="form-group">
          <label>Title</label>
          <input type="text" id="customTitle" placeholder="My Billboard">
        </div>

        <div class="form-group">
          <label>Message (Keep it short! Under 7 words per line)</label>
          <textarea id="customMessage" placeholder="BIG SALE&#10;Shop Today"></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Background Color</label>
            <div class="color-picker-group">
              <input type="color" id="customBgColor" value="#000000">
              <input type="text" id="customBgColorText" value="#000000" style="width: 100px;">
            </div>
          </div>
          
          <div class="form-group">
            <label>Text Color</label>
            <div class="color-picker-group">
              <input type="color" id="customTextColor" value="#FFFFFF">
              <input type="text" id="customTextColorText" value="#FFFFFF" style="width: 100px;">
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Font Size</label>
          <select id="customFontSize">
            <option value="small">Small</option>
            <option value="medium">Medium</option>
            <option value="large" selected>Large</option>
            <option value="xlarge">Extra Large</option>
          </select>
        </div>

        <button class="btn" style="width: 100%;" onclick="createCustomBillboard()">
          üé® Create Custom Billboard
        </button>
      </div>

      <!-- AI Image Generation Panel -->
      <div class="panel" style="grid-column: 1 / -1;">
        <div class="panel-header">
          <div class="panel-title">üñºÔ∏è Generate Billboard with AI Image</div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Image Prompt</label>
            <textarea id="imagePrompt" placeholder="Describe the image you want: e.g., 'A delicious pizza with fresh toppings on a wooden table'"></textarea>
          </div>
          
          <div class="form-group">
            <label>Billboard Message</label>
            <textarea id="imageMessage" placeholder="HOT & FRESH&#10;Order Now"></textarea>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Theme</label>
            <select id="imageTheme">
              <option value="food">Food</option>
              <option value="tech">Tech</option>
              <option value="retail">Retail</option>
              <option value="service">Service</option>
              <option value="event">Event</option>
            </select>
          </div>
        </div>

        <button class="btn" style="width: 100%;" onclick="generateWithImage()">
          üé® Generate Image & Create Billboard
        </button>
        
        <div id="imageGenStatus" style="margin-top: 12px; color: #888; font-size: 12px;"></div>
      </div>
    </div>
  </div>

  <!-- Plugins Tab -->
  <div id="tab-plugins" class="tab-content">
    <div class="grid">
      <!-- Plugin Marketplace -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">üîå Plugin Marketplace</div>
          <button class="btn btn-small" onclick="refreshPlugins()">‚ü≤ Refresh</button>
        </div>
        
        <div id="pluginsList">
          <div class="loading"></div>
        </div>
      </div>

      <!-- Kernel Status -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">‚öôÔ∏è Kernel Status</div>
          <button class="btn btn-small" onclick="bootKernel()">üîÑ Reboot</button>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="statTotalPlugins">0</div>
            <div class="stat-label">Total Plugins</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statActivePlugins">0</div>
            <div class="stat-label">Active</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statCrashedPlugins">0</div>
            <div class="stat-label">Crashed</div>
          </div>
        </div>

        <div style="margin-top: 20px;">
          <label>System Report</label>
          <pre id="kernelReport" style="background: #000; padding: 12px; border-radius: 6px; font-size: 11px; overflow-x: auto;"></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Logs & Reports Tab -->
  <div id="tab-logs" class="tab-content">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">üìù System Logs</div>
        <div class="quick-actions">
          <button class="btn btn-small btn-secondary" onclick="refreshLogs()">‚ü≤ Refresh</button>
          <button class="btn btn-small btn-danger" onclick="clearLogs()">üóëÔ∏è Clear</button>
        </div>
      </div>
      
      <div class="log-container" id="logsContainer">
        <div style="color: #666; text-align: center; padding: 20px;">Loading logs...</div>
      </div>
    </div>
  </div>
</div>

<script>
// ========== Global State ==========
let billboards = [];
let plugins = [];
let logs = [];
let currentTab = 'billboards';

const availablePlugins = [
  { name: 'billboard', displayName: 'Billboard Manager', description: 'Create and manage digital billboards', core: false },
  { name: 'aimessage', displayName: 'AI Message Generator', description: 'Rule-based message generation for billboards', core: false },
  { name: 'llm', displayName: 'OpenAI LLM', description: 'GPT integration and image generation', core: true },
  { name: 'infinite', displayName: 'Demo Plugin', description: 'Infinite loop for testing crashes', core: true }
];

// ========== Initialization ==========
document.addEventListener('DOMContentLoaded', async () => {
  await refreshAll();
  setInterval(refreshAll, 10000); // Auto-refresh every 10s
  
  // Color picker sync
  document.getElementById('customBgColor').addEventListener('input', (e) => {
    document.getElementById('customBgColorText').value = e.target.value;
  });
  document.getElementById('customTextColor').addEventListener('input', (e) => {
    document.getElementById('customTextColorText').value = e.target.value;
  });
});

async function refreshAll() {
  await Promise.all([
    refreshBillboards(),
    refreshPlugins(),
    refreshLogs()
  ]);
  updateStats();
}

// ========== Tab Management ==========
function switchTab(tabName) {
  currentTab = tabName;
  
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  
  event.target.classList.add('active');
  document.getElementById(`tab-${tabName}`).classList.add('active');
}

// ========== Billboards ==========
async function refreshBillboards() {
  try {
    const res = await fetch('/run/billboard', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'list' })
    });
    
    const data = await res.json();
    billboards = data.result || [];
    
    document.getElementById('billboardCount').textContent = `${billboards.length} Billboards`;
    renderBillboards();
  } catch (err) {
    console.error('Failed to refresh billboards:', err);
  }
}

function renderBillboards() {
  const container = document.getElementById('billboardsList');
  
  if (billboards.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üì∫</div>
        <div>No billboards yet. Create one in the "Create" tab!</div>
      </div>
    `;
    return;
  }
  
  container.innerHTML = billboards.map(bb => {
    const currentContent = bb.contents[bb.currentIndex] || bb.contents[0];
    return `
      <div class="billboard-card">
        <div class="billboard-card-header">
          <div class="billboard-title">#${bb.id} ${escapeHtml(bb.title)}</div>
          <div>
            <span class="badge">${bb.theme}</span>
            ${bb.autoRotate ? '<span class="badge">Auto-Rotate</span>' : ''}
          </div>
        </div>
        
        <div class="billboard-preview" style="background-color: ${currentContent.bgColor};">
          ${currentContent.imageUrl ? `<img src="${currentContent.imageUrl}" class="billboard-preview-image" />` : ''}
          <div class="billboard-preview-text" style="color: ${currentContent.textColor}; font-size: ${getFontSize(currentContent.fontSize)};">
            ${escapeHtml(currentContent.message)}
          </div>
        </div>
        
        <div class="stats-grid" style="margin-top: 12px;">
          <div class="stat-card">
            <div class="stat-value">${bb.contents.length}</div>
            <div class="stat-label">Contents</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${bb.stats.rotations}</div>
            <div class="stat-label">Rotations</div>
          </div>
        </div>
        
        <div class="quick-actions" style="margin-top: 12px;">
          <button class="btn btn-small" onclick="viewBillboard(${bb.id})">üëÅÔ∏è View</button>
          <button class="btn btn-small btn-secondary" onclick="addContent(${bb.id})">‚ûï Add Content</button>
          <button class="btn btn-small btn-danger" onclick="deleteBillboard(${bb.id})">üóëÔ∏è Delete</button>
        </div>
      </div>
    `;
  }).join('');
}

function getFontSize(size) {
  const sizes = { small: '18px', medium: '28px', large: '38px', xlarge: '48px' };
  return sizes[size] || '38px';
}

async function quickCreateBillboard() {
  const theme = document.getElementById('quickTheme').value;
  const keywordsStr = document.getElementById('quickKeywords').value;
  const keywords = keywordsStr ? keywordsStr.split(',').map(k => k.trim()) : [];
  
  try {
    // Generate message using AI Message plugin
    const msgRes = await fetch('/run/aimessage', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'generate', theme, keywords })
    });
    
    const msgData = await msgRes.json();
    if (msgData.error) throw new Error(msgData.error);
    
    const messageData = msgData.result;
    
    // Create billboard
    const bbRes = await fetch('/run/billboard', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'create',
        title: `${theme.charAt(0).toUpperCase() + theme.slice(1)} Billboard`,
        message: messageData.message,
        theme,
        bgColor: messageData.bgColor,
        textColor: messageData.textColor,
        fontSize: messageData.fontSize
      })
    });
    
    const bbData = await bbRes.json();
    if (bbData.error) throw new Error(bbData.error);
    
    showNotification('‚úÖ Billboard created successfully!');
    await refreshBillboards();
    switchTab('billboards');
  } catch (err) {
    showNotification('‚ùå Error: ' + err.message);
  }
}

async function createCustomBillboard() {
  const title = document.getElementById('customTitle').value || 'Custom Billboard';
  const message = document.getElementById('customMessage').value;
  const bgColor = document.getElementById('customBgColor').value;
  const textColor = document.getElementById('customTextColor').value;
  const fontSize = document.getElementById('customFontSize').value;
  
  if (!message.trim()) {
    showNotification('‚ùå Message is required!');
    return;
  }
  
  try {
    const res = await fetch('/run/billboard', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'create',
        title,
        message,
        bgColor,
        textColor,
        fontSize,
        theme: 'custom'
      })
    });
    
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    
    showNotification('‚úÖ Custom billboard created!');
    document.getElementById('customMessage').value = '';
    await refreshBillboards();
    switchTab('billboards');
  } catch (err) {
    showNotification('‚ùå Error: ' + err.message);
  }
}

async function generateWithImage() {
  const imagePrompt = document.getElementById('imagePrompt').value;
  const message = document.getElementById('imageMessage').value;
  const theme = document.getElementById('imageTheme').value;
  
  if (!imagePrompt.trim()) {
    showNotification('‚ùå Image prompt is required!');
    return;
  }
  
  try {
    const status = document.getElementById('imageGenStatus');
    status.textContent = 'üé® Generating image... This may take a moment...';
    status.style.color = '#00ff66';
    
    // Generate image
    const imgRes = await fetch('/generate/image', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt: imagePrompt })
    });
    
    const imgData = await imgRes.json();
    if (imgData.error) throw new Error(imgData.error);
    
    status.textContent = '‚úÖ Image generated! Creating billboard...';
    
    // Create billboard with image
    const bbRes = await fetch('/run/billboard', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'create',
        title: `AI Image: ${theme}`,
        message: message || 'CHECK THIS OUT!',
        imageUrl: imgData.url,
        theme,
        bgColor: '#000000',
        textColor: '#FFFFFF',
        fontSize: 'large'
      })
    });
    
    const bbData = await bbRes.json();
    if (bbData.error) throw new Error(bbData.error);
    
    status.textContent = '‚úÖ Billboard with AI image created successfully!';
    setTimeout(() => { status.textContent = ''; }, 3000);
    
    document.getElementById('imagePrompt').value = '';
    document.getElementById('imageMessage').value = '';
    
    await refreshBillboards();
    switchTab('billboards');
  } catch (err) {
    const status = document.getElementById('imageGenStatus');
    status.textContent = '‚ùå Error: ' + err.message;
    status.style.color = '#ff4444';
  }
}

async function deleteBillboard(id) {
  if (!confirm('Delete this billboard?')) return;
  
  try {
    await fetch('/run/billboard', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'delete', id })
    });
    
    await refreshBillboards();
    showNotification('‚úÖ Billboard deleted');
  } catch (err) {
    showNotification('‚ùå Error: ' + err.message);
  }
}

function viewBillboard(id) {
  window.open('/display', '_blank');
}

async function addContent(id) {
  const message = prompt('Enter message for new content:');
  if (!message) return;
  
  try {
    await fetch('/run/billboard', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'addContent', id, message })
    });
    
    await refreshBillboards();
    showNotification('‚úÖ Content added');
  } catch (err) {
    showNotification('‚ùå Error: ' + err.message);
  }
}

// ========== Plugins ==========
async function refreshPlugins() {
  try {
    const res = await fetch('/status');
    const status = await res.json();
    
    plugins = availablePlugins.map(p => ({
      ...p,
      status: status[p.name] || 'NOT_LOADED',
      loaded: status[p.name] !== undefined
    }));
    
    document.getElementById('pluginCount').textContent = 
      `${plugins.filter(p => p.status === 'ACTIVE').length} Plugins`;
    
    renderPlugins();
  } catch (err) {
    console.error('Failed to refresh plugins:', err);
  }
}

function renderPlugins() {
  const container = document.getElementById('pluginsList');
  
  container.innerHTML = plugins.map(p => `
    <div class="plugin-card ${p.status === 'ACTIVE' ? 'active' : ''} ${p.status.includes('CRASHED') ? 'error' : ''}">
      <div class="plugin-info">
        <div class="plugin-name">${p.displayName}</div>
        <div class="plugin-desc">${p.description}</div>
        <div class="plugin-status ${p.status === 'ACTIVE' ? 'active' : 'error'}">
          Status: ${p.status}
        </div>
      </div>
      <div>
        ${p.core 
          ? '<span class="badge">Core</span>' 
          : `<button class="btn btn-small ${p.loaded ? 'btn-danger' : ''}" 
               onclick="togglePlugin('${p.name}')">
              ${p.loaded ? 'Unload' : 'Load'}
            </button>`
        }
      </div>
    </div>
  `).join('');
}

async function togglePlugin(name) {
  try {
    const plugin = plugins.find(p => p.name === name);
    
    if (plugin.loaded) {
      await fetch(`/plugin/${name}`, { method: 'DELETE' });
    } else {
      await fetch(`/plugin/${name}`, { method: 'POST' });
    }
    
    await refreshPlugins();
    showNotification(`‚úÖ Plugin ${plugin.loaded ? 'unloaded' : 'loaded'}`);
  } catch (err) {
    showNotification('‚ùå Error: ' + err.message);
  }
}

async function bootKernel() {
  try {
    await fetch('/boot', { method: 'POST' });
    await refreshPlugins();
    showNotification('‚úÖ Kernel rebooted');
  } catch (err) {
    showNotification('‚ùå Error: ' + err.message);
  }
}

function updateStats() {
  const total = plugins.length;
  const active = plugins.filter(p => p.status === 'ACTIVE').length;
  const crashed = plugins.filter(p => p.status.includes('CRASHED')).length;
  
  document.getElementById('statTotalPlugins').textContent = total;
  document.getElementById('statActivePlugins').textContent = active;
  document.getElementById('statCrashedPlugins').textContent = crashed;
  
  fetch('/status')
    .then(r => r.json())
    .then(data => {
      document.getElementById('kernelReport').textContent = JSON.stringify(data, null, 2);
    });
}

// ========== Logs ==========
async function refreshLogs() {
  try {
    const res = await fetch('/logs');
    const data = await res.json();
    logs = data;
    
    renderLogs();
  } catch (err) {
    console.error('Failed to refresh logs:', err);
  }
}

function renderLogs() {
  const container = document.getElementById('logsContainer');
  
  if (logs.length === 0) {
    container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No logs available</div>';
    return;
  }
  
  container.innerHTML = logs.map(log => `
    <div class="log-entry ${log.level}">
      <span class="log-time">${new Date(log.timestamp).toLocaleTimeString()}</span>
      <span class="log-level">[${log.level}]</span>
      <span class="log-message">${escapeHtml(log.message)}</span>
    </div>
  `).join('');
}

async function clearLogs() {
  if (!confirm('Clear all logs?')) return;
  
  // Note: You'd need to implement a /logs/clear endpoint
  showNotification('‚ö†Ô∏è Clear logs endpoint not implemented');
}

// ========== Utilities ==========
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function showNotification(message) {
  const notif = document.createElement('div');
  notif.className = 'notification';
  notif.textContent = message;
  document.body.appendChild(notif);
  
  setTimeout(() => {
    notif.remove();
  }, 3000);
}
</script>

</body>
</html>
