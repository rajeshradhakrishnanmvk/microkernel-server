<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Billboard Feed - SLOP Architecture</title>

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    background: #0d0d0d;
    color: #ffffff;
    font-family: 'Arial Black', 'Helvetica', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Navigation Bar - Facebook-like */
  .navbar {
    background: linear-gradient(135deg, #ff006e 0%, #8338ec 50%, #3a86ff 100%);
    padding: 12px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 4px 20px rgba(255, 0, 110, 0.4);
    position: sticky;
    top: 0;
    z-index: 1000;
  }

  .navbar-brand {
    font-size: 28px;
    font-weight: 900;
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 3px 3px 0px rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .navbar-actions {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .nav-btn {
    background: rgba(255, 255, 255, 0.2);
    border: 3px solid #ffffff;
    color: #ffffff;
    padding: 10px 20px;
    border-radius: 50px;
    font-size: 13px;
    font-weight: 900;
    cursor: pointer;
    transition: all 0.3s;
    text-transform: uppercase;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
  }

  .nav-btn:hover {
    background: #ffffff;
    color: #ff006e;
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 6px 20px rgba(255, 255, 255, 0.4);
  }

  .system-indicator {
    background: rgba(0, 255, 102, 0.2);
    border: 2px solid #00ff66;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 11px;
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 600;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #00ff66;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* Layout - Facebook-like 3 column (SLOP: Server-rendered, Local-first, Optimistic, Progressive) */
  .main-container {
    max-width: 1800px;
    margin: 0 auto;
    padding: 20px;
    display: grid;
    grid-template-columns: 280px 1fr 320px;
    gap: 20px;
  }

  @media (max-width: 1400px) {
    .main-container {
      grid-template-columns: 260px 1fr;
    }
    .right-sidebar {
      display: none;
    }
  }

  @media (max-width: 900px) {
    .main-container {
      grid-template-columns: 1fr;
    }
    .left-sidebar {
      display: none;
    }
  }

  /* Sidebars */
  .left-sidebar, .right-sidebar {
    position: sticky;
    top: 80px;
    height: fit-content;
  }

  .sidebar-panel {
    background: #16213e;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    border: 1px solid #2a3f5f;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }

  .sidebar-title {
    font-size: 14px;
    font-weight: 700;
    color: #00ff66;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    padding-bottom: 8px;
    border-bottom: 2px solid #00ff66;
  }

  /* Plugin Cards (Left Sidebar) */
  .plugin-card {
    background: #0a0a0a;
    border: 1px solid #2a3f5f;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s;
  }

  .plugin-card.active {
    border-color: #00ff66;
    background: rgba(0, 255, 102, 0.05);
  }

  .plugin-info {
    flex: 1;
  }

  .plugin-name {
    font-size: 12px;
    font-weight: 600;
    color: #00ff66;
  }

  .plugin-status {
    font-size: 10px;
    color: #666;
  }

  .plugin-status.active {
    color: #00ff66;
  }

  .btn-small {
    background: linear-gradient(135deg, #00ff66 0%, #00cc52 100%);
    color: #000;
    border: none;
    padding: 4px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 10px;
    transition: all 0.3s;
  }

  .btn-small:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 255, 102, 0.5);
  }

  .btn-danger {
    background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
    color: #fff;
  }

  /* Stats (Right Sidebar) */
  .stats-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
  }

  .stat-card {
    background: #0a0a0a;
    border: 1px solid #2a3f5f;
    padding: 12px;
    border-radius: 8px;
    text-align: center;
  }

  .stat-value {
    font-size: 24px;
    font-weight: 900;
    color: #00ff66;
  }

  .stat-label {
    font-size: 10px;
    color: #888;
    text-transform: uppercase;
  }

  /* Feed Container - Center Column */
  .feed-container {
    max-width: 680px;
    margin: 0 auto;
  }

  /* Create Post Box - Facebook-like */
  .create-box {
    background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
    border: 5px solid #ff006e;
    border-radius: 30px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 
      0 4px 8px rgba(255, 0, 110, 0.3),
      0 8px 16px rgba(255, 0, 110, 0.2), 
      0 16px 32px rgba(0, 0, 0, 0.4),
      inset 0 0 20px rgba(255, 0, 110, 0.1);
    border-radius: 28px 32px 30px 35px;
  }

  .ai-quick-create {
    background: linear-gradient(135deg, rgba(0, 255, 136, 0.15) 0%, rgba(0, 204, 255, 0.15) 100%);
    border: 3px solid #00ff88;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 
      0 4px 20px rgba(0, 255, 136, 0.3),
      inset 0 0 20px rgba(0, 255, 136, 0.1);
  }

  .create-box h2 {
    font-size: 20px;
    color: #00ff88;
    margin-bottom: 16px;
    text-transform: uppercase;
    text-shadow: 2px 2px 0px rgba(0, 0, 0, 0.5);
  }

  .create-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }

  .create-tab {
    flex: 1;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid #8338ec;
    color: #ffffff;
    padding: 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
  }

  .create-tab.active {
    background: #8338ec;
    border-color: #00ff88;
    box-shadow: 0 0 15px rgba(131, 56, 236, 0.6);
  }

  .create-tab:hover:not(.active) {
    background: rgba(255, 255, 255, 0.15);
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  /* Enhancement Options - Unified UI */
  .enhancement-toggle {
    background: rgba(131, 56, 236, 0.2);
    border: 2px solid #8338ec;
    padding: 12px 16px;
    border-radius: 12px;
    margin: 16px 0;
    cursor: pointer;
    transition: all 0.3s;
    user-select: none;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .enhancement-toggle:hover {
    background: rgba(131, 56, 236, 0.3);
    border-color: #00ff88;
  }

  .enhancement-toggle strong {
    color: #00ff88;
  }

  #enhancement-icon {
    display: inline-block;
    transition: transform 0.3s;
    color: #00ff88;
    font-weight: bold;
  }

  #enhancement-icon.expanded {
    transform: rotate(90deg);
  }

  .enhancement-panel {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease-out;
  }

  .enhancement-panel.expanded {
    max-height: 2000px;
  }

  .enhancement-section {
    background: rgba(10, 10, 10, 0.5);
    border: 1px solid #2a3f5f;
    border-radius: 10px;
    margin-bottom: 12px;
    overflow: hidden;
  }

  .section-header {
    padding: 12px 16px;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(131, 56, 236, 0.1);
  }

  .section-header:hover {
    background: rgba(131, 56, 236, 0.2);
  }

  .section-header strong {
    color: #ffffff;
  }

  .section-icon {
    display: inline-block;
    transition: transform 0.3s;
    color: #00ff88;
    font-weight: bold;
    width: 16px;
  }

  .section-icon.expanded {
    transform: rotate(90deg);
  }

  .section-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
    padding: 0 16px;
  }

  .section-content.expanded {
    max-height: 800px;
    padding: 16px;
  }

  .action-btn {
    width: 100%;
    background: linear-gradient(135deg, #8338ec 0%, #ff006e 100%);
    border: 3px solid #ffffff;
    color: #ffffff;
    padding: 12px 20px;
    border-radius: 50px;
    font-size: 14px;
    font-weight: 900;
    cursor: pointer;
    transition: all 0.3s;
    text-transform: uppercase;
    box-shadow: 0 4px 15px rgba(131, 56, 236, 0.4);
    margin-top: 8px;
  }

  .action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(131, 56, 236, 0.6);
  }

  .ai-btn {
    background: linear-gradient(135deg, #00ff88 0%, #00cc66 100%);
    color: #000000;
  }

  .magf-btn {
    background: linear-gradient(135deg, #ff006e 0%, #8338ec 100%);
  }

  .create-input {
    width: 100%;
    background: #0a0a0a;
    border: 3px solid #8338ec;
    color: #ffffff;
    padding: 16px;
    border-radius: 12px;
    font-family: 'Arial Black', sans-serif;
    font-size: 16px;
    margin-bottom: 12px;
    resize: vertical;
    min-height: 80px;
    box-shadow: inset 0 4px 10px rgba(0, 0, 0, 0.5);
  }

  .create-input:focus {
    outline: none;
    border-color: #00ff88;
    box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
  }

  .create-input::placeholder {
    color: #666;
    font-weight: normal;
  }

  input[type="text"],
  input[type="number"],
  select {
    width: 100%;
    background: #0a0a0a;
    color: #00ff66;
    border: 2px solid #2a3f5f;
    padding: 10px;
    border-radius: 8px;
    font-family: 'Segoe UI', sans-serif;
    font-size: 13px;
    margin-bottom: 10px;
  }

  input:focus, select:focus {
    outline: none;
    border-color: #00ff66;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .form-group {
    margin-bottom: 12px;
  }

  label {
    display: block;
    font-size: 11px;
    color: #888;
    text-transform: uppercase;
    margin-bottom: 6px;
    font-weight: 600;
  }

  .create-options {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 16px;
  }

  .color-btn {
    width: 50px;
    height: 50px;
    border: 4px solid #ffffff;
    border-radius: 48% 52% 50% 48% / 52% 48% 52% 48%;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 
      0 4px 8px rgba(0, 0, 0, 0.4),
      inset 0 -2px 4px rgba(0, 0, 0, 0.3);
  }

  .color-btn:hover {
    transform: scale(1.15) rotate(10deg);
    box-shadow: 
      0 6px 16px rgba(0, 0, 0, 0.5),
      0 0 20px currentColor;
  }

  .color-btn.active {
    border-width: 6px;
    transform: scale(1.15);
    box-shadow: 
      0 6px 12px rgba(0, 0, 0, 0.5),
      0 0 30px currentColor;
    animation: pulse-active 2s ease-in-out infinite;
  }

  @keyframes pulse-active {
    0%, 100% { transform: scale(1.15); }
    50% { transform: scale(1.2); }
  }

  .post-btn {
    background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
    border: none;
    color: #000;
    padding: 14px 40px;
    border-radius: 35px;
    font-size: 16px;
    font-weight: 900;
    cursor: pointer;
    text-transform: uppercase;
    box-shadow: 
      0 6px 12px rgba(0, 255, 136, 0.4),
      0 12px 24px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
    width: 100%;
  }

  .post-btn:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: 
      0 8px 16px rgba(0, 255, 136, 0.5),
      0 16px 32px rgba(0, 0, 0, 0.4);
  }

  .post-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Billboard Card - Puffy Style */
  .billboard-card {
    background: #1a1a2e;
    border-radius: 30px;
    margin-bottom: 32px;
    overflow: hidden;
    box-shadow: 
      0 2px 4px rgba(255, 0, 110, 0.3),
      0 8px 16px rgba(131, 56, 236, 0.4),
      0 16px 32px rgba(58, 134, 255, 0.3),
      0 24px 48px rgba(0, 0, 0, 0.6);
    transform: rotate(0.5deg);
    border: 6px solid;
    border-image: linear-gradient(135deg, #ff006e, #8338ec, #3a86ff) 1;
    position: relative;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .billboard-card:hover {
    transform: rotate(0.5deg) scale(1.02);
    box-shadow: 
      0 4px 8px rgba(255, 0, 110, 0.4),
      0 12px 24px rgba(131, 56, 236, 0.5),
      0 24px 48px rgba(58, 134, 255, 0.4),
      0 32px 64px rgba(0, 0, 0, 0.7);
  }

  .billboard-card:nth-child(even) {
    transform: rotate(-0.8deg);
    border-radius: 25px 32px 28px 35px;
  }

  .billboard-card:nth-child(3n) {
    transform: rotate(1.2deg);
    border-radius: 35px 28px 30px 25px;
  }

  .billboard-header {
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    background: linear-gradient(
      135deg, 
      rgba(255, 0, 110, 0.2) 0%,
      rgba(131, 56, 236, 0.15) 50%,
      rgba(58, 134, 255, 0.1) 100%
    );
    border-bottom: 4px solid #ff006e;
  }

  .billboard-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #ff006e, #8338ec);
    border: 3px solid #00ff88;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: 900;
  }

  .billboard-info {
    flex: 1;
  }

  .billboard-author {
    font-size: 16px;
    font-weight: 900;
    color: #00ff88;
    text-transform: uppercase;
  }

  .billboard-time {
    font-size: 12px;
    color: #888;
    font-weight: normal;
  }

  .billboard-content {
    padding: 0;
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
  }

  .billboard-text {
    font-size: 48px;
    font-weight: 900;
    text-align: center;
    padding: 60px 40px;
    width: 100%;
    text-transform: uppercase;
    line-height: 1.1;
    text-shadow: 
      3px 3px 0px rgba(0, 0, 0, 0.3),
      6px 6px 0px rgba(0, 0, 0, 0.2),
      9px 9px 12px rgba(0, 0, 0, 0.4);
    letter-spacing: 2px;
    transform: rotate(-2deg);
  }

  .billboard-image {
    max-width: 80%;
    max-height: 250px;
    border-radius: 16px;
    margin: 20px auto;
    display: block;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
  }

  .billboard-footer {
    padding: 16px 20px;
    display: flex;
    gap: 12px;
    background: linear-gradient(
      135deg,
      rgba(131, 56, 236, 0.2) 0%,
      rgba(58, 134, 255, 0.15) 100%
    );
    border-top: 4px solid #8338ec;
  }

  .action-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 3px solid #ffffff;
    color: #ffffff;
    padding: 12px 20px;
    border-radius: 25px;
    font-size: 14px;
    font-weight: 900;
    cursor: pointer;
    transition: all 0.3s ease;
    flex: 1;
    text-transform: uppercase;
    box-shadow: 
      0 4px 8px rgba(0, 0, 0, 0.3),
      inset 0 -2px 4px rgba(0, 0, 0, 0.2);
  }

  .action-btn:hover {
    background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
    color: #000;
    transform: scale(1.05) translateY(-2px);
  }

  .action-btn.liked {
    background: linear-gradient(135deg, #ff006e 0%, #ff3388 100%);
    border-color: #ff006e;
    box-shadow: 0 4px 12px rgba(255, 0, 110, 0.5);
  }

  /* Loading */
  .loading {
    text-align: center;
    padding: 40px;
    color: #888;
    font-size: 18px;
  }

  .spinner {
    border: 4px solid rgba(255, 255, 255, 0.1);
    border-top: 4px solid #00ff88;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin-loader 1s linear infinite;
    margin: 20px auto;
  }

  @keyframes spin-loader {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Template Cards */
  .template-card {
    background: #0a0a0a;
    border: 2px solid #2a3f5f;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.3s;
  }

  .template-card:hover {
    border-color: #00ff66;
  }

  .template-card.selected {
    border-color: #00ff66;
    background: rgba(0, 255, 102, 0.1);
  }

  .template-name {
    font-size: 12px;
    font-weight: 600;
    color: #00ff66;
    margin-bottom: 4px;
  }

  .template-preview {
    padding: 6px;
    border-radius: 4px;
    text-align: center;
    font-size: 10px;
    font-weight: 700;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .navbar-brand {
      font-size: 20px;
    }

    .billboard-text {
      font-size: 32px;
      padding: 40px 20px;
    }

    .create-box {
      padding: 16px;
    }

    .nav-btn {
      padding: 8px 16px;
      font-size: 12px;
    }

    .form-row {
      grid-template-columns: 1fr;
    }
  }

  /* System Log Modal */
  .modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    animation: fadeIn 0.3s;
  }

  .modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .modal-content {
    background: #16213e;
    border: 3px solid #00ff66;
    border-radius: 16px;
    padding: 24px;
    max-width: 900px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0, 255, 102, 0.3);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid #00ff66;
  }

  .modal-title {
    font-size: 24px;
    font-weight: 900;
    color: #00ff66;
  }

  .close-btn {
    background: #ff006e;
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
  }

  .log-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }

  .log-filter {
    background: #0a0a0a;
    border: 2px solid #2a3f5f;
    color: #00ff66;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
  }

  .log-entry {
    background: #0a0a0a;
    border-left: 4px solid #00ff66;
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 11px;
  }

  .log-entry.ERROR {
    border-left-color: #ff006e;
  }

  .log-entry.WARN {
    border-left-color: #ffaa00;
  }

  .log-entry.INFO {
    border-left-color: #3a86ff;
  }

  .log-entry.DEBUG {
    border-left-color: #888;
  }

  .log-timestamp {
    color: #888;
    font-size: 10px;
  }

  .log-level {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 700;
    font-size: 9px;
    margin: 0 6px;
  }

  .log-level.ERROR {
    background: #ff006e;
    color: white;
  }

  .log-level.WARN {
    background: #ffaa00;
    color: black;
  }

  .log-level.INFO {
    background: #3a86ff;
    color: white;
  }

  .log-level.DEBUG {
    background: #888;
    color: white;
  }

  .log-plugin {
    color: #00ff66;
    font-weight: 700;
  }

  .log-message {
    color: #fff;
    margin-top: 4px;
  }

  .log-data {
    color: #aaa;
    margin-top: 4px;
    font-size: 10px;
  }

</style>
</head>
<body>

<!-- Navigation -->
<div class="navbar">
  <div class="navbar-brand">
    üéØ BILLBOARD FEED
  </div>
  <div class="navbar-actions">
    <div class="system-indicator">
      <span class="status-dot"></span>
      <span id="kernel-status">SLOP Active</span>
    </div>
    <button class="nav-btn" onclick="showSystemLog()">üìã SYSTEM LOG</button>
    <button class="nav-btn" onclick="scrollToTop()">‚Üë TOP</button>
    <button class="nav-btn" onclick="refreshFeed()">‚Üª REFRESH</button>
  </div>
</div>

<!-- Main Container - Facebook-like 3 column -->
<div class="main-container">
  
  <!-- Left Sidebar - Plugin Management -->
  <div class="left-sidebar">
    <div class="sidebar-panel">
      <div class="sidebar-title">üîå Plugins</div>
      <div id="plugin-list">
        <div class="loading" style="padding: 20px; font-size: 12px;">Loading...</div>
      </div>
    </div>

    <div class="sidebar-panel">
      <div class="sidebar-title">üìã Templates</div>
      <div id="template-list">
        <div class="template-card" onclick="selectTemplate('sale', '#7700ff', '#ffff00')">
          <div class="template-name">üí∞ Sale/Promo</div>
          <div class="template-preview" style="background: #7700ff; color: #ffff00;">SALE!</div>
        </div>
        <div class="template-card" onclick="selectTemplate('announcement', '#ff0088', '#00ff88')">
          <div class="template-name">üì¢ Announcement</div>
          <div class="template-preview" style="background: #ff0088; color: #00ff88;">NEWS!</div>
        </div>
        <div class="template-card" onclick="selectTemplate('event', '#0088ff', '#ffaa00')">
          <div class="template-name">üéâ Event</div>
          <div class="template-preview" style="background: #0088ff; color: #ffaa00;">EVENT!</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Center Feed -->
  <div class="feed-container">
    
    <!-- Create Billboard Box - Unified UI -->
    <div class="create-box">
      <h2>‚ú® Create Billboard</h2>
      
      <!-- AI-Powered One-Click Creation -->
      <div class="ai-quick-create">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
          <span style="font-size: 24px;">ü§ñ</span>
          <div>
            <strong style="font-size: 16px; color: #00ff66;">AI-Powered Billboard Creation</strong>
            <div style="font-size: 11px; color: #888;">Just describe your billboard and we'll create it instantly!</div>
          </div>
        </div>
        <input 
          type="text" 
          id="ai-quick-input" 
          class="create-input" 
          placeholder="e.g., 'New Product Launch' or 'Summer Sale 50% Off' or 'Join our Event Saturday'"
          style="margin-bottom: 12px; height: 50px; font-size: 16px;"
        />
        <button class="post-btn" onclick="createAIBillboard()" style="background: linear-gradient(135deg, #00ff88 0%, #00ccff 100%); border-color: #00ff88;">
          ‚ú® CREATE WITH AI (ONE CLICK!)
        </button>
      </div>
    </div>

    <!-- Billboard Feed -->
    <div id="billboard-feed">
      <div class="loading">
        <div class="spinner"></div>
        Loading billboards...
      </div>
    </div>

  </div>

  <!-- Right Sidebar - Stats & Activity -->
  <div class="right-sidebar">
    <div class="sidebar-panel">
      <div class="sidebar-title">üìä Statistics</div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="total-billboards">0</div>
          <div class="stat-label">Total</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="active-billboards">0</div>
          <div class="stat-label">Active</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="total-likes">0</div>
          <div class="stat-label">Likes</div>
        </div>
      </div>
    </div>

    <div class="sidebar-panel">
      <div class="sidebar-title">üìã System Log</div>
      <div id="system-log-preview" style="font-size: 10px; color: #888; max-height: 200px; overflow-y: auto;">
        <div style="padding: 10px; text-align: center;">Loading...</div>
      </div>
      <button class="btn-small" onclick="showSystemLog()" style="width: 100%; margin-top: 10px;">
        View Full Log
      </button>
    </div>

    <div class="sidebar-panel">
      <div class="sidebar-title">‚ö° SLOP Status</div>
      <div style="font-size: 11px; color: #888; line-height: 1.6;">
        <div style="margin-bottom: 8px;">
          <strong style="color: #00ff66;">Server:</strong> Connected
        </div>
        <div style="margin-bottom: 8px;">
          <strong style="color: #00ff66;">Local:</strong> IndexedDB Ready
        </div>
        <div style="margin-bottom: 8px;">
          <strong style="color: #00ff66;">Optimistic:</strong> Enabled
        </div>
        <div>
          <strong style="color: #00ff66;">Progressive:</strong> Active
        </div>
      </div>
    </div>
  </div>

</div>

<!-- System Log Modal -->
<div id="log-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">üìã System Event Log</div>
      <button class="close-btn" onclick="closeSystemLog()">‚úï Close</button>
    </div>
    
    <div class="log-controls">
      <select class="log-filter" id="log-level-filter" onchange="filterLogs()">
        <option value="">All Levels</option>
        <option value="ERROR">Error</option>
        <option value="WARN">Warning</option>
        <option value="INFO">Info</option>
        <option value="DEBUG">Debug</option>
      </select>
      
      <select class="log-filter" id="log-plugin-filter" onchange="filterLogs()">
        <option value="">All Plugins</option>
        <option value="KERNEL">Kernel</option>
        <option value="billboard">Billboard</option>
        <option value="magf">MAGF</option>
        <option value="llm">LLM</option>
      </select>
      
      <button class="btn-small" onclick="refreshLogs()">üîÑ Refresh</button>
      <button class="btn-small btn-danger" onclick="clearLogs()">üóëÔ∏è Clear</button>
    </div>
    
    <div id="log-entries" style="max-height: 500px; overflow-y: auto;">
      <div style="text-align: center; color: #888; padding: 20px;">Loading logs...</div>
    </div>
  </div>
</div>

<script>
// ============================================
// SLOP Architecture Implementation
// Server-Local-Optimistic-Progressive
// ============================================

// State Management (Local-first)
const state = {
  billboards: [],
  selectedBgColor: '#7700ff',
  selectedTextColor: '#ffff00',
  currentUser: 'Billboard Creator',
  plugins: [],
  stats: { total: 0, active: 0, likes: 0 },
  // Optimistic update queue
  pendingUpdates: [],
  // Progressive enhancement
  isOnline: navigator.onLine,
  // Generated AI image (temporary)
  generatedImage: ''
};

// IndexedDB for Local persistence
let db;
const DB_NAME = 'BillboardDB';
const DB_VERSION = 1;

// Initialize IndexedDB (Local)
function initDB() {
  const request = indexedDB.open(DB_NAME, DB_VERSION);
  
  request.onerror = () => {
    console.error('IndexedDB error:', request.error);
  };
  
  request.onsuccess = () => {
    db = request.result;
    loadBillboards();
  };
  
  request.onupgradeneeded = (event) => {
    db = event.target.result;
    if (!db.objectStoreNames.contains('billboards')) {
      const objectStore = db.createObjectStore('billboards', { keyPath: 'id', autoIncrement: true });
      objectStore.createIndex('timestamp', 'timestamp', { unique: false });
    }
  };
}

// Local Storage helpers
function saveBillboardLocal(billboard) {
  const transaction = db.transaction(['billboards'], 'readwrite');
  const objectStore = transaction.objectStore('billboards');
  objectStore.add(billboard);
}

function loadBillboardsLocal() {
  return new Promise((resolve) => {
    const transaction = db.transaction(['billboards'], 'readonly');
    const objectStore = transaction.objectStore('billboards');
    const request = objectStore.getAll();
    
    request.onsuccess = () => {
      resolve(request.result || []);
    };
    
    request.onerror = () => {
      resolve([]);
    };
  });
}

// ============================================
// Tab Management (Legacy - kept for compatibility)
// ============================================
function switchCreateTab(tabName) {
  // Update tabs
  document.querySelectorAll('.create-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  event.target.classList.add('active');

  // Update content
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });
  document.getElementById(`tab-${tabName}`).classList.add('active');
}

// ============================================
// Unified UI Enhancement Options
// ============================================
function toggleEnhancements() {
  const panel = document.getElementById('enhancement-options');
  const icon = document.getElementById('enhancement-icon');
  
  if (panel.classList.contains('expanded')) {
    panel.classList.remove('expanded');
    icon.classList.remove('expanded');
  } else {
    panel.classList.add('expanded');
    icon.classList.add('expanded');
  }
}

function toggleSection(sectionName) {
  const content = document.getElementById(`section-${sectionName}`);
  const icon = document.getElementById(`${sectionName}-icon`);
  
  if (content.classList.contains('expanded')) {
    content.classList.remove('expanded');
    icon.classList.remove('expanded');
  } else {
    content.classList.add('expanded');
    icon.classList.add('expanded');
  }
}

function updatePreview() {
  // Could add live preview functionality here
  const text = document.getElementById('billboard-input').value;
  // Future: update a live preview area
}

function updateCustomColors() {
  const bgColor = document.getElementById('bg-color').value;
  const textColor = document.getElementById('text-color').value;
  state.selectedBgColor = bgColor;
  state.selectedTextColor = textColor;
}

// ============================================
// Color Selection
// ============================================
function selectColor(bgColor, textColor) {
  state.selectedBgColor = bgColor;
  state.selectedTextColor = textColor;
  
  // Update active state
  document.querySelectorAll('.color-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');

  // Update advanced tab if needed
  if (document.getElementById('bg-color')) {
    document.getElementById('bg-color').value = bgColor;
    document.getElementById('text-color').value = textColor;
  }
}

// ============================================
// Template Selection
// ============================================
function selectTemplate(type, bgColor, textColor) {
  selectColor(bgColor, textColor);
  
  // Update template cards
  document.querySelectorAll('.template-card').forEach(card => {
    card.classList.remove('selected');
  });
  event.target.closest('.template-card').classList.add('selected');
}

// ============================================
// AI Generation (Progressive Enhancement)
// ============================================
async function generateWithAI() {
  const topic = document.getElementById('ai-topic').value;
  const template = document.getElementById('ai-template').value;
  const imagePrompt = document.getElementById('image-prompt').value;

  if (!topic.trim()) {
    alert('Please enter a topic for AI generation');
    return;
  }

  try {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'ü§ñ GENERATING...';

    // Call LLM plugin to generate text
    const response = await fetch('/run/billboard', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'generateMessage',
        topic,
        template
      })
    });

    const data = await response.json();
    
    if (data.result && data.result.text) {
      document.getElementById('billboard-input').value = data.result.text;
    }

    // Generate image if prompt provided
    if (imagePrompt.trim()) {
      btn.textContent = 'üñºÔ∏è GENERATING IMAGE...';
      
      const imageResponse = await fetch('/run/llm', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'generateImage',
          prompt: imagePrompt,
          description: imagePrompt
        })
      });

      const imageData = await imageResponse.json();
      
      if (imageData.result && imageData.result.imageBase64) {
        // Store generated image in state for later use
        state.generatedImage = `data:image/png;base64,${imageData.result.imageBase64}`;
      }
    }
    
    // Switch to simple tab to show result
    document.querySelector('.create-tab:first-child').click();

    btn.disabled = false;
    btn.textContent = 'ü§ñ GENERATE WITH AI';
    
  } catch (err) {
    console.error('AI generation failed:', err);
    // Fallback to local generation
    const fallbackText = generateFallbackMessage(topic, template);
    document.getElementById('billboard-input').value = fallbackText;
    
    event.target.disabled = false;
    event.target.textContent = 'ü§ñ GENERATE WITH AI';
  }
}

function generateFallbackMessage(topic, template) {
  const templates = {
    sale: `${topic.toUpperCase()}\nHUGE SALE\nLIMITED TIME`,
    announcement: `${topic.toUpperCase()}\nBIG NEWS\nCOMING SOON`,
    brand: `${topic.toUpperCase()}\nYOUR CHOICE\nBEST QUALITY`,
    event: `${topic.toUpperCase()}\nJOIN US\nDON'T MISS`
  };
  return templates[template] || `${topic.toUpperCase()}\nNEW\nCHECK IT OUT`;
}

// ============================================
// AI-Powered One-Click Billboard Creation
// ============================================
async function createAIBillboard() {
  const description = document.getElementById('ai-quick-input').value.trim();
  
  if (!description) {
    alert('Please enter a description for your billboard (e.g., "New Product Launch")');
    return;
  }

  try {
    const btn = event.target;
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'ü§ñ AI GENERATING...';

    // Call the billboard plugin's AI generation endpoint
    const response = await fetch('/run/billboard', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'generateAIBillboard',
        description: description
      })
    });

    const data = await response.json();
    
    // Check for errors in response
    if (data.error) {
      throw new Error(data.error);
    }
    
    if (data.result) {
      btn.textContent = '‚ú® CREATING BILLBOARD...';
      
      // Show AI generation details in console for debugging
      console.log('ü§ñ AI Generated Billboard:', {
        text: data.result.text,
        template: data.result.template,
        hasImage: !!data.result.imageData,
        hasAudio: !!data.result.audioId,
        aiGenerated: data.result.aiGenerated
      });
      
      // The AI has generated all the options, now create the billboard
      const billboardConfig = data.result;
      
      // Optimistic Update - Add immediately to UI
      const optimisticBillboard = {
        id: Date.now(),
        text: billboardConfig.text,
        bgColor: billboardConfig.bgColor,
        textColor: billboardConfig.textColor,
        fontSize: billboardConfig.fontSize,
        imageData: billboardConfig.imageData || '',
        audioId: billboardConfig.audioId || null,
        author: billboardConfig.author || 'AI Assistant',
        timestamp: new Date(),
        likes: 0,
        liked: false,
        pending: true,
        aiGenerated: true
      };

      // Add to state immediately (Optimistic)
      state.billboards.unshift(optimisticBillboard);
      renderFeed();

      // Clear input
      document.getElementById('ai-quick-input').value = '';

      // Save to local DB
      if (db) {
        saveBillboardLocal(optimisticBillboard);
      }

      // Now create on server
      try {
        const createResponse = await fetch('/run/billboard', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'create',
            text: billboardConfig.text,
            bgColor: billboardConfig.bgColor,
            textColor: billboardConfig.textColor,
            fontSize: billboardConfig.fontSize,
            imageData: billboardConfig.imageData || '',
            audioId: billboardConfig.audioId || null,
            template: billboardConfig.template,
            rotation: billboardConfig.rotation || 5000,
            author: billboardConfig.author || 'AI Assistant',
            timestamp: new Date().toISOString()
          })
        });

        const createData = await createResponse.json();
        
        if (createData.result) {
          // Update with server ID
          const billboard = state.billboards.find(b => b.id === optimisticBillboard.id);
          if (billboard) {
            billboard.id = createData.result.id;
            billboard.pending = false;
          }
        }
      } catch (err) {
        console.error('Server sync failed, using local data:', err);
        optimisticBillboard.pending = false;
      }

      updateStats();
      
      // Success message with details
      const features = [];
      if (billboardConfig.imageData) features.push('üñºÔ∏è Image');
      if (billboardConfig.audioId) features.push('üîä Audio');
      if (billboardConfig.aiGenerated) features.push('ü§ñ AI Text');
      
      const featureText = features.length > 0 ? ` (${features.join(', ')})` : '';
      
      btn.textContent = `‚úÖ CREATED${featureText}`;
      setTimeout(() => {
        btn.disabled = false;
        btn.textContent = originalText;
      }, 3000);
      
      // Scroll to see the new billboard
      window.scrollTo({ top: document.querySelector('.feed-container').offsetTop, behavior: 'smooth' });
      
    } else if (data.error) {
      throw new Error(data.error);
    } else {
      throw new Error('AI generation returned no result');
    }
    
  } catch (err) {
    console.error('AI billboard creation failed:', err);
    
    // Show detailed error message
    let errorMsg = `Failed to create AI billboard:\n\n${err.message}`;
    
    // Add helpful suggestions based on error type
    if (err.message.includes('API') || err.message.includes('key')) {
      errorMsg += '\n\nüí° Check that your OPENAI_API_KEY is set correctly.';
    } else if (err.message.includes('network') || err.message.includes('fetch')) {
      errorMsg += '\n\nüí° Check your internet connection.';
    } else if (err.message.includes('trim')) {
      errorMsg += '\n\nüí° The AI response format was unexpected. Try again.';
    }
    
    errorMsg += '\n\nYou can still create billboards manually using the form above.';
    
    alert(errorMsg);
    
    event.target.disabled = false;
    event.target.textContent = '‚ú® CREATE WITH AI (ONE CLICK!)';
  }
}

// ============================================
// Create Billboard (Optimistic Update)
// ============================================
async function createBillboard() {
  // Get text from active tab
  let text = document.getElementById('billboard-input').value.trim();
  if (!text && document.getElementById('billboard-text-advanced')) {
    text = document.getElementById('billboard-text-advanced').value.trim();
  }
  
  if (!text) {
    alert('Please enter your billboard message!');
    return;
  }

  // Validate
  const lines = text.split('\n');
  for (let line of lines) {
    const words = line.trim().split(/\s+/);
    if (words.length > 7) {
      alert('Keep it under 7 words per line for maximum impact!');
      return;
    }
  }

  if (lines.length > 3) {
    alert('Maximum 3 lines for billboard readability!');
    return;
  }

  // Get colors
  let bgColor = state.selectedBgColor;
  let textColor = state.selectedTextColor;
  
  if (document.getElementById('bg-color')) {
    bgColor = document.getElementById('bg-color').value;
    textColor = document.getElementById('text-color').value;
  }

  // Optimistic Update - Add immediately to UI
  const optimisticBillboard = {
    id: Date.now(),
    text: text,
    bgColor: bgColor,
    textColor: textColor,
    imageData: state.generatedImage || '',
    author: state.currentUser,
    timestamp: new Date(),
    likes: 0,
    liked: false,
    pending: true // Mark as pending server confirmation
  };

  // Add to state immediately (Optimistic)
  state.billboards.unshift(optimisticBillboard);
  renderFeed();

  // Clear input
  document.getElementById('billboard-input').value = '';
  if (document.getElementById('billboard-text-advanced')) {
    document.getElementById('billboard-text-advanced').value = '';
  }
  
  // Clear generated image
  state.generatedImage = '';

  // Save to local DB
  if (db) {
    saveBillboardLocal(optimisticBillboard);
  }

  // Try to sync with server (Progressive)
  try {
    const response = await fetch('/run/billboard', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'create',
        text: text,
        bgColor: bgColor,
        textColor: textColor,
        imageData: state.generatedImage || '',
        fontSize: document.getElementById('font-size')?.value || '48px',
        author: state.currentUser,
        timestamp: new Date().toISOString()
      })
    });

    const data = await response.json();
    
    if (data.result) {
      // Update with server ID
      const billboard = state.billboards.find(b => b.id === optimisticBillboard.id);
      if (billboard) {
        billboard.id = data.result.id;
        billboard.pending = false;
      }
    }
  } catch (err) {
    console.error('Server sync failed, using local data:', err);
    // Already added optimistically, so continue
    optimisticBillboard.pending = false;
  }

  updateStats();
}

// ============================================
// Load Billboards (Server + Local)
// ============================================
async function loadBillboards() {
  // Load from local first (Fast)
  if (db) {
    const localBillboards = await loadBillboardsLocal();
    if (localBillboards.length > 0) {
      state.billboards = localBillboards.map(bb => ({
        ...bb,
        timestamp: new Date(bb.timestamp),
        likes: bb.likes || 0,
        liked: false
      }));
      renderFeed();
      updateStats();
    }
  }

  // Then sync with server (Progressive Enhancement)
  try {
    const response = await fetch('/run/billboard', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'list' })
    });

    const data = await response.json();
    
    if (data.result && Array.isArray(data.result)) {
      state.billboards = data.result.map(bb => ({
        ...bb,
        timestamp: new Date(bb.timestamp || Date.now()),
        likes: bb.likes || 0,
        liked: false
      }));
      renderFeed();
      updateStats();
    }
  } catch (err) {
    console.error('Failed to load from server, using local data:', err);
    // Already rendered local data, so continue
    if (state.billboards.length === 0) {
      loadSampleData();
    }
  }
}

// ============================================
// Load Sample Data (Fallback)
// ============================================
function loadSampleData() {
  state.billboards = [
    {
      id: 1,
      text: 'HUGE SALE\n50% OFF\nTODAY ONLY',
      bgColor: '#7700ff',
      textColor: '#ffff00',
      author: 'Billboard Creator',
      timestamp: new Date(Date.now() - 3600000),
      likes: 42,
      liked: false
    },
    {
      id: 2,
      text: 'NEW PRODUCT\nLAUNCH\nCOMING SOON',
      bgColor: '#ff0088',
      textColor: '#00ff88',
      author: 'Billboard Creator',
      timestamp: new Date(Date.now() - 7200000),
      likes: 28,
      liked: false
    },
    {
      id: 3,
      text: 'JOIN US\nBIG EVENT\nSATURDAY',
      bgColor: '#0088ff',
      textColor: '#ffaa00',
      author: 'Billboard Creator',
      timestamp: new Date(Date.now() - 10800000),
      likes: 15,
      liked: false
    }
  ];
  renderFeed();
  updateStats();
}

// ============================================
// Render Feed
// ============================================
function renderFeed() {
  const feed = document.getElementById('billboard-feed');
  
  if (state.billboards.length === 0) {
    feed.innerHTML = `
      <div class="loading">
        No billboards yet. Create the first one! üì¢
      </div>
    `;
    return;
  }

  feed.innerHTML = state.billboards.map((billboard) => `
    <div class="billboard-card" data-billboard-id="${billboard.id}">
      <!-- Header -->
      <div class="billboard-header">
        <div class="billboard-avatar">
          ${billboard.author ? billboard.author.charAt(0).toUpperCase() : 'A'}
        </div>
        <div class="billboard-info">
          <div class="billboard-author">${billboard.author || 'Anonymous'}</div>
          <div class="billboard-time">
            ${getTimeAgo(billboard.timestamp)}
            ${billboard.pending ? '<span style="color: #ffaa00;"> ‚Ä¢ Syncing...</span>' : ''}
            ${billboard.aiGenerated ? '<span style="color: #00ff66;"> ‚Ä¢ AI Generated</span>' : ''}
          </div>
        </div>
      </div>
      
      <!-- Content -->
      <div class="billboard-content" style="background: ${billboard.bgColor};">
        ${billboard.imageData ? `<img src="${billboard.imageData}" class="billboard-image">` : ''}
        <div class="billboard-text" style="color: ${billboard.textColor};">
          ${billboard.text}
        </div>
        ${billboard.audioId ? `
          <div style="position: absolute; bottom: 20px; right: 20px;">
            <button class="action-btn" onclick="playBillboardAudio('${billboard.audioId}', ${billboard.id})" 
                    style="background: rgba(0, 255, 102, 0.2); border-color: #00ff66; padding: 8px 16px;">
              üîä PLAY AUDIO
            </button>
          </div>
        ` : ''}
      </div>
      
      <!-- Footer Actions -->
      <div class="billboard-footer">
        <button class="action-btn ${billboard.liked ? 'liked' : ''}" onclick="toggleLike(${billboard.id})">
          ${billboard.liked ? '‚ù§Ô∏è' : 'ü§ç'} ${billboard.likes} LIKES
        </button>
        <button class="action-btn" onclick="shareBillboard(${billboard.id})">
          üì§ SHARE
        </button>
        <button class="action-btn" onclick="deleteBillboard(${billboard.id})">
          üóëÔ∏è DELETE
        </button>
      </div>
    </div>
  `).join('');
}

// ============================================
// Billboard Actions
// ============================================
function toggleLike(id) {
  const billboard = state.billboards.find(b => b.id === id);
  if (billboard) {
    // Optimistic update
    billboard.liked = !billboard.liked;
    billboard.likes += billboard.liked ? 1 : -1;
    renderFeed();
    updateStats();
    
    // Sync to server in background
    syncLikeToServer(id, billboard.liked);
  }
}

async function syncLikeToServer(id, liked) {
  try {
    await fetch('/run/billboard', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        action: 'like', 
        id, 
        liked 
      })
    });
  } catch (err) {
    console.error('Failed to sync like:', err);
    // Keep optimistic update
  }
}

async function deleteBillboard(id) {
  if (!confirm('Delete this billboard?')) return;

  // Optimistic update
  const index = state.billboards.findIndex(b => b.id === id);
  if (index > -1) {
    state.billboards.splice(index, 1);
    renderFeed();
    updateStats();
  }

  // Sync to server
  try {
    await fetch('/run/billboard', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'delete', id })
    });
  } catch (err) {
    console.error('Failed to delete from server:', err);
  }
}

function shareBillboard(id) {
  const billboard = state.billboards.find(b => b.id === id);
  if (billboard) {
    if (navigator.share) {
      navigator.share({
        title: 'Billboard',
        text: billboard.text,
        url: window.location.href
      });
    } else {
      alert(`Billboard shared!\n\n"${billboard.text}"`);
    }
  }
}

// ============================================
// Audio Playback
// ============================================
let currentAudio = null;

function playBillboardAudio(audioId, billboardId) {
  // Stop any currently playing audio
  if (currentAudio) {
    currentAudio.pause();
    currentAudio = null;
  }

  // Create new audio element
  const audio = new Audio(`/audio/${audioId}`);
  currentAudio = audio;

  // Update button state
  const card = document.querySelector(`[data-billboard-id="${billboardId}"]`);
  if (card) {
    const btn = card.querySelector('button[onclick*="playBillboardAudio"]');
    if (btn) {
      const originalText = btn.innerHTML;
      btn.innerHTML = '‚è∏Ô∏è PLAYING...';
      btn.style.background = 'linear-gradient(135deg, #00ff66 0%, #00cc52 100%)';
      
      audio.onended = () => {
        btn.innerHTML = originalText;
        btn.style.background = 'rgba(0, 255, 102, 0.2)';
        currentAudio = null;
      };
      
      audio.onerror = () => {
        btn.innerHTML = '‚ùå ERROR';
        btn.style.background = 'rgba(255, 0, 110, 0.2)';
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.style.background = 'rgba(0, 255, 102, 0.2)';
        }, 2000);
        currentAudio = null;
      };
    }
  }

  // Play the audio
  audio.play().catch(err => {
    console.error('Failed to play audio:', err);
    alert('Failed to play audio. Please try again.');
  });
}

// ============================================
// Plugin Management
// ============================================
async function loadPlugins() {
  try {
    const res = await fetch('/status');
    const status = await res.json();
    
    const pluginList = document.getElementById('plugin-list');
    pluginList.innerHTML = '';
    
    const plugins = [
      { name: 'billboard', desc: 'Billboard Manager' },
      { name: 'magf', desc: 'MAGF Animation' },
      { name: 'llm', desc: 'AI Integration' }
    ];

    plugins.forEach(plugin => {
      const isActive = status[plugin.name] === 'ACTIVE';
      
      const card = document.createElement('div');
      card.className = `plugin-card ${isActive ? 'active' : ''}`;
      card.innerHTML = `
        <div class="plugin-info">
          <div class="plugin-name">${plugin.name}</div>
          <div class="plugin-status ${isActive ? 'active' : ''}">
            ${status[plugin.name] || 'NOT_LOADED'}
          </div>
        </div>
        <button class="btn-small ${isActive ? 'btn-danger' : ''}" 
                onclick="togglePlugin('${plugin.name}', ${isActive})">
          ${isActive ? 'Off' : 'On'}
        </button>
      `;
      pluginList.appendChild(card);
    });
    
  } catch (err) {
    console.error('Failed to load plugins:', err);
    document.getElementById('plugin-list').innerHTML = '<div style="font-size: 11px; color: #888; padding: 10px;">Offline mode</div>';
  }
}

async function togglePlugin(name, isActive) {
  try {
    if (isActive) {
      await fetch(`/plugin/${name}`, { method: 'DELETE' });
    } else {
      await fetch(`/plugin/${name}`, { method: 'POST' });
    }
    await loadPlugins();
  } catch (err) {
    console.error('Failed to toggle plugin:', err);
  }
}

// ============================================
// MAGF Billboard Creation
// ============================================
async function createMAGFBillboard(event) {
  // Use the main input instead of separate magf-text input
  const text = document.getElementById('billboard-input').value.trim();
  const animationType = document.getElementById('magf-animation').value;
  const fps = parseInt(document.getElementById('magf-fps').value);
  const duration = parseInt(document.getElementById('magf-duration').value);

  if (!text) {
    alert('Please enter billboard text for MAGF animation');
    return;
  }

  try {
    const btn = event ? event.target : document.querySelector('.post-btn');
    btn.disabled = true;
    btn.textContent = 'üé¨ CREATING MAGF...';

    // Generate frames for MAGF animation
    const frames = await generateMAGFFrames(text, animationType, fps, duration);

    // Create MAGF file
    const magfResponse = await fetch('/run/magf', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'create',
        name: `Billboard-${Date.now()}`,
        frames: frames,
        fps: fps,
        duration: duration,
        metadata: {
          billboardText: text,
          animation: animationType
        }
      })
    });

    const magfData = await magfResponse.json();

    if (magfData.result) {
      // Create billboard with MAGF reference
      const billboardResponse = await fetch('/run/billboard', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'create',
          text: text,
          magfData: magfData.result.id,
          bgColor: state.selectedBgColor,
          textColor: state.selectedTextColor,
          author: state.currentUser,
          timestamp: new Date().toISOString()
        })
      });

      const billboard = await billboardResponse.json();

      if (billboard.result) {
        // Add to feed
        state.billboards.unshift({
          ...billboard.result,
          timestamp: new Date(billboard.result.timestamp || Date.now()),
          likes: 0,
          liked: false
        });
        renderFeed();
        updateStats();

        // Clear main input
        document.getElementById('billboard-input').value = '';
        
        alert('MAGF Billboard created successfully! üé¨');
      }
    }

    btn.disabled = false;
    btn.textContent = 'üé¨ CREATE MAGF BILLBOARD';

  } catch (err) {
    console.error('Failed to create MAGF billboard:', err);
    alert('Failed to create MAGF billboard. See console for details.');
    const btn = event ? event.target : document.querySelector('.post-btn');
    if (btn) {
      btn.disabled = false;
      btn.textContent = 'üé¨ CREATE MAGF BILLBOARD';
    }
  }
}

async function generateMAGFFrames(text, animationType, fps, duration) {
  // Generate canvas frames for animation
  const canvas = document.createElement('canvas');
  canvas.width = 640;
  canvas.height = 360;
  const ctx = canvas.getContext('2d');

  const totalFrames = fps * duration;
  const frames = [];

  for (let i = 0; i < totalFrames; i++) {
    const progress = i / totalFrames;
    
    // Clear canvas
    ctx.fillStyle = state.selectedBgColor;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Apply animation
    ctx.save();
    applyAnimation(ctx, animationType, progress, canvas.width, canvas.height);

    // Draw text
    ctx.fillStyle = state.selectedTextColor;
    ctx.font = 'bold 48px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    
    const lines = text.split('\n');
    const lineHeight = 60;
    const startY = canvas.height / 2 - (lines.length - 1) * lineHeight / 2;
    
    lines.forEach((line, index) => {
      ctx.fillText(line, canvas.width / 2, startY + index * lineHeight);
    });

    ctx.restore();

    // Convert canvas to blob
    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
    const arrayBuffer = await blob.arrayBuffer();
    
    frames.push({
      byteLength: arrayBuffer.byteLength,
      width: canvas.width,
      height: canvas.height,
      data: Array.from(new Uint8Array(arrayBuffer))
    });
  }

  return frames;
}

function applyAnimation(ctx, type, progress, width, height) {
  switch (type) {
    case 'pulse':
      const scale = 0.9 + Math.sin(progress * Math.PI * 4) * 0.1;
      ctx.translate(width / 2, height / 2);
      ctx.scale(scale, scale);
      ctx.translate(-width / 2, -height / 2);
      break;
    
    case 'slide':
      const slideX = progress < 0.3 ? -width + (width * progress / 0.3) : 0;
      ctx.translate(slideX, 0);
      break;
    
    case 'bounce':
      const bounceY = progress < 0.5 ? Math.abs(Math.sin(progress * Math.PI * 4)) * 50 : 0;
      ctx.translate(0, -bounceY);
      break;
    
    case 'fade':
      const alpha = Math.sin(progress * Math.PI);
      ctx.globalAlpha = alpha;
      break;
  }
}

// ============================================
// System Log Management
// ============================================
let currentLogs = [];
let logUpdateInterval = null;

async function loadSystemLog() {
  try {
    const level = document.getElementById('log-level-filter')?.value || '';
    const plugin = document.getElementById('log-plugin-filter')?.value || '';
    
    const params = new URLSearchParams();
    if (level) params.append('level', level);
    if (plugin) params.append('plugin', plugin);
    params.append('limit', '100');
    
    const response = await fetch(`/logs?${params}`);
    const logs = await response.json();
    
    currentLogs = logs;
    renderLogs(logs);
    
    // Update preview
    updateLogPreview(logs.slice(-5));
    
  } catch (err) {
    console.error('Failed to load logs:', err);
  }
}

function renderLogs(logs) {
  const container = document.getElementById('log-entries');
  
  if (!logs || logs.length === 0) {
    container.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">No log entries found</div>';
    return;
  }
  
  container.innerHTML = logs.reverse().map(log => `
    <div class="log-entry ${log.level}">
      <div>
        <span class="log-timestamp">${new Date(log.timestamp).toLocaleTimeString()}</span>
        <span class="log-level ${log.level}">${log.level}</span>
        <span class="log-plugin">[${log.plugin}]</span>
      </div>
      <div class="log-message">${log.message}</div>
      ${log.data && Object.keys(log.data).length > 0 ? 
        `<div class="log-data">${JSON.stringify(log.data)}</div>` : ''}
    </div>
  `).join('');
}

function updateLogPreview(logs) {
  const preview = document.getElementById('system-log-preview');
  
  if (!logs || logs.length === 0) {
    preview.innerHTML = '<div style="padding: 10px; text-align: center;">No recent activity</div>';
    return;
  }
  
  preview.innerHTML = logs.reverse().map(log => `
    <div style="margin-bottom: 6px; padding: 4px; background: #0a0a0a; border-radius: 4px;">
      <span style="color: ${getLevelColor(log.level)}">‚óè</span>
      <span style="color: #00ff66;">[${log.plugin}]</span>
      <span style="color: #aaa;">${log.message.substring(0, 30)}${log.message.length > 30 ? '...' : ''}</span>
    </div>
  `).join('');
}

function getLevelColor(level) {
  const colors = {
    ERROR: '#ff006e',
    WARN: '#ffaa00',
    INFO: '#3a86ff',
    DEBUG: '#888'
  };
  return colors[level] || '#888';
}

function showSystemLog() {
  document.getElementById('log-modal').classList.add('active');
  loadSystemLog();
  
  // Auto-refresh logs every 5 seconds
  if (logUpdateInterval) clearInterval(logUpdateInterval);
  logUpdateInterval = setInterval(loadSystemLog, 5000);
}

function closeSystemLog() {
  document.getElementById('log-modal').classList.remove('active');
  if (logUpdateInterval) {
    clearInterval(logUpdateInterval);
    logUpdateInterval = null;
  }
}

function filterLogs() {
  loadSystemLog();
}

function refreshLogs() {
  loadSystemLog();
}

async function clearLogs() {
  if (!confirm('Clear all system logs?')) return;
  
  try {
    await fetch('/logs', { method: 'DELETE' });
    loadSystemLog();
  } catch (err) {
    console.error('Failed to clear logs:', err);
  }
}

// ============================================
// Update Statistics
// ============================================
function updateStats() {
  state.stats.total = state.billboards.length;
  state.stats.active = state.billboards.filter(b => !b.pending).length;
  state.stats.likes = state.billboards.reduce((sum, b) => sum + b.likes, 0);
  
  document.getElementById('total-billboards').textContent = state.stats.total;
  document.getElementById('active-billboards').textContent = state.stats.active;
  document.getElementById('total-likes').textContent = state.stats.likes;
}

// ============================================
// Utility Functions
// ============================================
function getTimeAgo(timestamp) {
  const seconds = Math.floor((new Date() - new Date(timestamp)) / 1000);
  
  if (seconds < 60) return 'just now';
  if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
  if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
  return `${Math.floor(seconds / 86400)}d ago`;
}

function scrollToTop() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function refreshFeed() {
  loadBillboards();
  loadPlugins();
}

// ============================================
// Network Status (Progressive Enhancement)
// ============================================
window.addEventListener('online', () => {
  state.isOnline = true;
  document.getElementById('kernel-status').textContent = 'SLOP Active';
  // Sync pending updates
  loadBillboards();
});

window.addEventListener('offline', () => {
  state.isOnline = false;
  document.getElementById('kernel-status').textContent = 'Offline Mode';
});

// ============================================
// Initialize (SLOP Architecture)
// ============================================
document.addEventListener('DOMContentLoaded', () => {
  // Initialize IndexedDB
  initDB();
  
  // Load plugins
  loadPlugins();
  
  // Load system log preview
  loadSystemLog();
  
  // Auto-refresh log preview every 10 seconds
  setInterval(() => {
    loadSystemLog();
  }, 10000);
  
  // Progressive enhancement - load billboards
  // Local data loads first, server syncs in background
  setTimeout(() => {
    if (state.billboards.length === 0) {
      loadBillboards();
    }
  }, 100);
});
</script>

</body>
</html>
