<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Digital Billboard Manager - SLOP Architecture</title>

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
    color: #eaeaea;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    min-height: 100vh;
  }

  .header {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    padding: 20px 30px;
    border-bottom: 2px solid #00ff66;
    box-shadow: 0 4px 20px rgba(0, 255, 102, 0.1);
  }

  .header h1 {
    font-size: 28px;
    margin-bottom: 10px;
    color: #00ff66;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .header-subtitle {
    font-size: 14px;
    color: #888;
    font-family: monospace;
  }

  .system-status {
    display: flex;
    gap: 20px;
    margin-top: 15px;
    flex-wrap: wrap;
  }

  .status-chip {
    background: rgba(0, 255, 102, 0.1);
    border: 1px solid #00ff66;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #00ff66;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .container {
    max-width: 1800px;
    margin: 0 auto;
    padding: 20px;
  }

  .main-grid {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }

  .sidebar {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .panel {
    background: #16213e;
    border-radius: 12px;
    padding: 20px;
    border: 1px solid #2a3f5f;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }

  .panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid #00ff66;
  }

  .panel-title {
    font-size: 18px;
    font-weight: 600;
    color: #00ff66;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .btn {
    background: linear-gradient(135deg, #00ff66 0%, #00cc52 100%);
    color: #000;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 13px;
    transition: all 0.3s;
    box-shadow: 0 2px 10px rgba(0, 255, 102, 0.3);
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0, 255, 102, 0.5);
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  .btn-secondary {
    background: #1a1a2e;
    color: #00ff66;
    border: 1px solid #00ff66;
  }

  .btn-danger {
    background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
    color: #fff;
  }

  .btn-small {
    padding: 6px 12px;
    font-size: 11px;
  }

  .btn-block {
    width: 100%;
    margin-bottom: 10px;
  }

  input[type="text"],
  input[type="number"],
  input[type="color"],
  select,
  textarea {
    width: 100%;
    background: #0a0a0a;
    color: #00ff66;
    border: 1px solid #2a3f5f;
    padding: 10px;
    border-radius: 6px;
    font-family: 'Segoe UI', sans-serif;
    font-size: 13px;
    margin-bottom: 12px;
    transition: border-color 0.3s;
  }

  input:focus,
  select:focus,
  textarea:focus {
    outline: none;
    border-color: #00ff66;
    box-shadow: 0 0 10px rgba(0, 255, 102, 0.2);
  }

  textarea {
    min-height: 80px;
    resize: vertical;
    font-family: monospace;
    font-size: 14px;
  }

  label {
    display: block;
    font-size: 12px;
    color: #888;
    text-transform: uppercase;
    margin-bottom: 6px;
    font-weight: 600;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  /* Billboard Preview */
  .billboard-preview-large {
    background: #000;
    border-radius: 12px;
    border: 3px solid #00ff66;
    min-height: 400px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    padding: 40px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 8px 40px rgba(0, 255, 102, 0.3);
  }

  .billboard-image {
    max-width: 60%;
    max-height: 200px;
    margin-bottom: 20px;
    border-radius: 8px;
    object-fit: contain;
  }

  .billboard-text {
    font-size: 64px;
    font-weight: 900;
    text-transform: uppercase;
    text-align: center;
    line-height: 1.1;
    white-space: pre-line;
    text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8);
  }

  .billboard-rotation-indicator {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0, 0, 0, 0.7);
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 11px;
    color: #00ff66;
  }

  /* Billboard Cards */
  .billboard-card {
    background: #0a0a0a;
    border: 1px solid #2a3f5f;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    transition: all 0.3s;
    cursor: pointer;
  }

  .billboard-card:hover {
    border-color: #00ff66;
    box-shadow: 0 4px 20px rgba(0, 255, 102, 0.2);
  }

  .billboard-card.active {
    border-color: #00ff66;
    background: rgba(0, 255, 102, 0.05);
  }

  .billboard-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .billboard-card-title {
    font-size: 14px;
    font-weight: 600;
    color: #00ff66;
  }

  .billboard-card-preview {
    background: #000;
    padding: 12px;
    border-radius: 4px;
    text-align: center;
    margin-bottom: 8px;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .billboard-card-text {
    font-size: 12px;
    font-weight: 700;
    white-space: pre-line;
  }

  .billboard-card-image {
    max-width: 100%;
    max-height: 50px;
    margin-bottom: 4px;
  }

  .billboard-card-actions {
    display: flex;
    gap: 8px;
  }

  /* Plugin Cards */
  .plugin-card {
    background: #0a0a0a;
    border: 1px solid #2a3f5f;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s;
  }

  .plugin-card.active {
    border-color: #00ff66;
    background: rgba(0, 255, 102, 0.05);
  }

  .plugin-card.error {
    border-color: #ff4444;
  }

  .plugin-info {
    flex: 1;
  }

  .plugin-name {
    font-size: 13px;
    font-weight: 600;
    color: #00ff66;
    margin-bottom: 2px;
  }

  .plugin-status {
    font-size: 10px;
    color: #666;
  }

  .plugin-status.active {
    color: #00ff66;
  }

  .plugin-status.error {
    color: #ff4444;
  }

  /* Log Container */
  .log-container {
    background: #000;
    border-radius: 6px;
    padding: 12px;
    max-height: 300px;
    overflow-y: auto;
    font-family: 'Courier New', monospace;
    font-size: 11px;
  }

  .log-entry {
    padding: 4px;
    border-left: 3px solid #333;
    margin-bottom: 4px;
    display: flex;
    gap: 8px;
  }

  .log-entry.INFO {
    border-left-color: #0099ff;
    color: #0099ff;
  }

  .log-entry.SUCCESS {
    border-left-color: #00ff66;
    color: #00ff66;
  }

  .log-entry.WARN {
    border-left-color: #ffaa00;
    color: #ffaa00;
  }

  .log-entry.ERROR {
    border-left-color: #ff4444;
    color: #ff4444;
  }

  .log-time {
    color: #666;
    min-width: 60px;
  }

  .log-message {
    color: #ccc;
  }

  /* Template Cards */
  .template-card {
    background: #0a0a0a;
    border: 2px solid #2a3f5f;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s;
  }

  .template-card:hover {
    border-color: #00ff66;
  }

  .template-card.selected {
    border-color: #00ff66;
    background: rgba(0, 255, 102, 0.1);
  }

  .template-name {
    font-size: 13px;
    font-weight: 600;
    color: #00ff66;
    margin-bottom: 4px;
  }

  .template-preview {
    padding: 8px;
    border-radius: 4px;
    text-align: center;
    font-size: 10px;
    font-weight: 700;
    margin-bottom: 6px;
  }

  .template-rules {
    font-size: 10px;
    color: #888;
  }

  /* Tabs */
  .tabs {
    display: flex;
    gap: 2px;
    margin-bottom: 20px;
    border-bottom: 2px solid #2a3f5f;
  }

  .tab {
    padding: 12px 24px;
    cursor: pointer;
    background: #0a0a0a;
    border: none;
    color: #888;
    font-weight: 600;
    transition: all 0.3s;
    border-bottom: 3px solid transparent;
  }

  .tab:hover {
    color: #00ff66;
  }

  .tab.active {
    color: #00ff66;
    border-bottom-color: #00ff66;
    background: #16213e;
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  /* Color picker */
  .color-group {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .color-preview {
    width: 50px;
    height: 50px;
    border-radius: 6px;
    border: 2px solid #2a3f5f;
  }

  input[type="color"] {
    width: 60px;
    height: 40px;
    border: none;
    cursor: pointer;
  }

  /* Loading spinner */
  .spinner {
    border: 3px solid #2a3f5f;
    border-top: 3px solid #00ff66;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    animation: spin 1s linear infinite;
    display: inline-block;
    margin-left: 8px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Scrollbar styling */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  ::-webkit-scrollbar-track {
    background: #0a0a0a;
  }

  ::-webkit-scrollbar-thumb {
    background: #2a3f5f;
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: #00ff66;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }

  .stat-card {
    background: #0a0a0a;
    border: 1px solid #2a3f5f;
    padding: 16px;
    border-radius: 8px;
    text-align: center;
  }

  .stat-value {
    font-size: 32px;
    font-weight: 900;
    color: #00ff66;
    margin-bottom: 4px;
  }

  .stat-label {
    font-size: 11px;
    color: #888;
    text-transform: uppercase;
  }

  @media (max-width: 1200px) {
    .main-grid {
      grid-template-columns: 1fr;
    }
    
    .stats-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <h1>üé¨ Digital Billboard Manager</h1>
  <div class="header-subtitle">SLOP Architecture ‚Ä¢ Microkernel ‚Ä¢ Dynamic Plugin System</div>
  <div class="system-status">
    <div class="status-chip">
      <span class="status-dot"></span>
      <span id="kernel-status">Kernel: Initializing...</span>
    </div>
    <div class="status-chip">
      <span class="status-dot"></span>
      <span id="plugin-count">Plugins: 0</span>
    </div>
  </div>
</div>

<!-- Main Container -->
<div class="container">
  
  <!-- Main Grid -->
  <div class="main-grid">
    
    <!-- Sidebar -->
    <div class="sidebar">
      
      <!-- Plugin Marketplace -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">üîå Plugin Marketplace</div>
        </div>
        <div id="plugin-list"></div>
        <button class="btn btn-secondary btn-block" onclick="refreshPlugins()">‚Üª Refresh Status</button>
      </div>

      <!-- Templates -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">üìã Templates</div>
        </div>
        <div id="template-list"></div>
      </div>

    </div>

    <!-- Main Content Area -->
    <div>
      
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="switchTab('create')">Create Billboard</button>
        <button class="tab" onclick="switchTab('manage')">Manage Billboards</button>
        <button class="tab" onclick="switchTab('preview')">Live Preview</button>
        <button class="tab" onclick="switchTab('logs')">Logs & Reports</button>
      </div>

      <!-- Tab: Create Billboard -->
      <div id="tab-create" class="tab-content active">
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">‚ú® Create New Billboard</div>
          </div>

          <div class="form-group">
            <label>Billboard Text (Max 7 words per line, 3 lines max)</label>
            <textarea id="billboard-text" placeholder="HUGE SALE&#10;50% OFF NOW&#10;LIMITED TIME" rows="3"></textarea>
            <small style="color: #888; font-size: 11px;">‚úì Bold, attention-grabbing ‚Ä¢ ‚úì Under 7 words per line</small>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Background Color</label>
              <div class="color-group">
                <input type="color" id="bg-color" value="#000000">
                <div class="color-preview" id="bg-preview" style="background: #000000"></div>
              </div>
            </div>
            <div class="form-group">
              <label>Text Color</label>
              <div class="color-group">
                <input type="color" id="text-color" value="#FFFFFF">
                <div class="color-preview" id="text-preview" style="background: #FFFFFF"></div>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Font Size</label>
              <select id="font-size">
                <option value="48px">Small (48px)</option>
                <option value="56px">Medium (56px)</option>
                <option value="64px" selected>Large (64px)</option>
                <option value="72px">Extra Large (72px)</option>
                <option value="84px">Huge (84px)</option>
              </select>
            </div>
            <div class="form-group">
              <label>Rotation Speed (ms)</label>
              <input type="number" id="rotation-speed" value="5000" min="1000" step="1000">
            </div>
          </div>

          <div class="form-group">
            <label>AI Image Generation (Optional)</label>
            <input type="text" id="image-prompt" placeholder="e.g., Happy shoppers with shopping bags">
            <button class="btn btn-secondary btn-block" onclick="generateImage()">
              üé® Generate Image with AI
            </button>
          </div>

          <div class="form-group" id="image-preview-container" style="display: none;">
            <label>Generated Image</label>
            <img id="generated-image-preview" style="max-width: 100%; border-radius: 8px; border: 2px solid #00ff66;">
          </div>

          <button class="btn btn-block" onclick="createBillboard()">
            Create Billboard
          </button>

          <hr style="border: none; border-top: 1px solid #2a3f5f; margin: 20px 0;">

          <div class="form-group">
            <label>ü§ñ AI Message Generator</label>
            <input type="text" id="ai-topic" placeholder="Enter topic (e.g., Summer Sale, New Product)">
            <select id="ai-template">
              <option value="sale">Sale/Promotion</option>
              <option value="announcement">Announcement</option>
              <option value="brand">Brand Awareness</option>
              <option value="event">Event Promotion</option>
            </select>
            <button class="btn btn-secondary btn-block" onclick="generateMessage()">
              Generate AI Message
            </button>
          </div>

        </div>
      </div>

      <!-- Tab: Manage Billboards -->
      <div id="tab-manage" class="tab-content">
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">üìä Billboard Management</div>
            <button class="btn btn-small" onclick="loadBillboards()">‚Üª Refresh</button>
          </div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="total-billboards">0</div>
              <div class="stat-label">Total Billboards</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="active-billboards">0</div>
              <div class="stat-label">Active</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="total-views">0</div>
              <div class="stat-label">Total Views</div>
            </div>
          </div>

          <div id="billboard-list"></div>
        </div>
      </div>

      <!-- Tab: Live Preview -->
      <div id="tab-preview" class="tab-content">
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">üëÅÔ∏è Live Billboard Preview</div>
            <button class="btn btn-small btn-secondary" onclick="toggleRotation()">
              <span id="rotation-btn-text">‚ñ∂ Start Rotation</span>
            </button>
          </div>

          <div class="billboard-preview-large" id="live-preview">
            <div class="billboard-rotation-indicator" id="rotation-indicator" style="display: none;">
              Rotating: <span id="rotation-countdown">5</span>s
            </div>
            <img id="preview-image" class="billboard-image" style="display: none;">
            <div class="billboard-text" id="preview-text">
              CREATE A BILLBOARD
            </div>
          </div>

          <div style="margin-top: 20px; text-align: center; color: #888; font-size: 12px;">
            ‚úì Designed for 3-second attention grab ‚Ä¢ High contrast ‚Ä¢ Bold typography
          </div>
        </div>
      </div>

      <!-- Tab: Logs & Reports -->
      <div id="tab-logs" class="tab-content">
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">üìã System Logs & Reports</div>
            <button class="btn btn-small btn-secondary" onclick="clearLogs()">Clear Logs</button>
          </div>
          <div class="log-container" id="log-container"></div>
        </div>

        <div class="panel" style="margin-top: 20px;">
          <div class="panel-header">
            <div class="panel-title">‚öôÔ∏è Kernel Status</div>
            <button class="btn btn-small" onclick="bootKernel()">Reboot Kernel</button>
          </div>
          <div id="kernel-report"></div>
        </div>
      </div>

    </div>

  </div>

</div>

<script>
// ============================================
// State Management
// ============================================
const state = {
  billboards: [],
  currentBillboard: null,
  selectedTemplate: null,
  rotationInterval: null,
  rotationIndex: 0,
  generatedImageData: null
};

// ============================================
// Logging System
// ============================================
function log(level, message) {
  const container = document.getElementById('log-container');
  const time = new Date().toLocaleTimeString();
  const entry = document.createElement('div');
  entry.className = `log-entry ${level}`;
  entry.innerHTML = `
    <span class="log-time">${time}</span>
    <span class="log-level">${level}</span>
    <span class="log-message">${message}</span>
  `;
  container.insertBefore(entry, container.firstChild);
  
  // Keep only last 100 logs
  while (container.children.length > 100) {
    container.removeChild(container.lastChild);
  }
}

function clearLogs() {
  document.getElementById('log-container').innerHTML = '';
  log('INFO', 'Logs cleared');
}

// ============================================
// Tab Management
// ============================================
function switchTab(tabName) {
  // Update tab buttons
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });
  event.target.classList.add('active');

  // Update tab content
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });
  document.getElementById(`tab-${tabName}`).classList.add('active');

  log('INFO', `Switched to ${tabName} tab`);

  // Load data if needed
  if (tabName === 'manage') {
    loadBillboards();
  } else if (tabName === 'preview') {
    updatePreview();
  }
}

// ============================================
// Plugin Management
// ============================================
async function loadPlugins() {
  try {
    const res = await fetch('/status');
    const status = await res.json();
    
    const pluginList = document.getElementById('plugin-list');
    pluginList.innerHTML = '';
    
    let activeCount = 0;
    const plugins = [
      { name: 'billboard', desc: 'Digital Billboard Manager' },
      { name: 'llm', desc: 'OpenAI Integration' }
    ];

    plugins.forEach(plugin => {
      const isActive = status[plugin.name] === 'ACTIVE';
      if (isActive) activeCount++;
      
      const card = document.createElement('div');
      card.className = `plugin-card ${status[plugin.name] === 'ACTIVE' ? 'active' : ''} ${status[plugin.name]?.includes('CRASHED') ? 'error' : ''}`;
      card.innerHTML = `
        <div class="plugin-info">
          <div class="plugin-name">${plugin.name}</div>
          <div class="plugin-status ${status[plugin.name] === 'ACTIVE' ? 'active' : 'error'}">
            ${status[plugin.name] || 'NOT_LOADED'}
          </div>
        </div>
        <button class="btn btn-small ${isActive ? 'btn-danger' : ''}" 
                onclick="togglePlugin('${plugin.name}', ${isActive})">
          ${isActive ? 'Unload' : 'Load'}
        </button>
      `;
      pluginList.appendChild(card);
    });

    document.getElementById('plugin-count').textContent = `Plugins: ${activeCount}/${plugins.length}`;
    document.getElementById('kernel-status').textContent = 'Kernel: Active';
    
  } catch (err) {
    log('ERROR', `Failed to load plugins: ${err.message}`);
  }
}

async function togglePlugin(name, isActive) {
  try {
    if (isActive) {
      const res = await fetch(`/plugin/${name}`, { method: 'DELETE' });
      const data = await res.json();
      log('SUCCESS', `Plugin ${name} unloaded`);
    } else {
      const res = await fetch(`/plugin/${name}`, { method: 'POST' });
      const data = await res.json();
      log('SUCCESS', `Plugin ${name} loaded`);
    }
    await loadPlugins();
  } catch (err) {
    log('ERROR', `Failed to toggle plugin: ${err.message}`);
  }
}

async function refreshPlugins() {
  log('INFO', 'Refreshing plugin status...');
  await loadPlugins();
}

async function bootKernel() {
  try {
    log('INFO', 'Rebooting kernel...');
    const res = await fetch('/boot', { method: 'POST' });
    const data = await res.json();
    log('SUCCESS', 'Kernel rebooted successfully');
    
    const report = document.getElementById('kernel-report');
    report.innerHTML = `<pre style="color: #00ff66; font-family: monospace; font-size: 12px;">${JSON.stringify(data, null, 2)}</pre>`;
    
    await loadPlugins();
  } catch (err) {
    log('ERROR', `Kernel reboot failed: ${err.message}`);
  }
}

// ============================================
// Template Management
// ============================================
async function loadTemplates() {
  try {
    const res = await fetch('/run/billboard', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'getTemplates' })
    });
    
    const data = await res.json();
    const templates = data.result;
    
    const templateList = document.getElementById('template-list');
    templateList.innerHTML = '';
    
    templates.forEach(template => {
      const card = document.createElement('div');
      card.className = 'template-card';
      card.onclick = () => selectTemplate(template);
      card.innerHTML = `
        <div class="template-name">${template.name}</div>
        <div class="template-preview" style="background: ${template.bgColor}; color: ${template.textColor}; font-size: ${template.fontSize};">
          PREVIEW
        </div>
        <div class="template-rules">${template.rules.join(' ‚Ä¢ ')}</div>
      `;
      templateList.appendChild(card);
    });
    
  } catch (err) {
    log('ERROR', `Failed to load templates: ${err.message}`);
  }
}

function selectTemplate(template) {
  state.selectedTemplate = template;
  
  // Update form
  document.getElementById('bg-color').value = template.bgColor;
  document.getElementById('text-color').value = template.textColor;
  document.getElementById('font-size').value = template.fontSize;
  
  // Update previews
  document.getElementById('bg-preview').style.background = template.bgColor;
  document.getElementById('text-preview').style.background = template.textColor;
  
  // Update template cards
  document.querySelectorAll('.template-card').forEach(card => {
    card.classList.remove('selected');
  });
  event.target.closest('.template-card').classList.add('selected');
  
  log('INFO', `Template selected: ${template.name}`);
}

// ============================================
// Billboard Creation
// ============================================
async function createBillboard() {
  const text = document.getElementById('billboard-text').value;
  const bgColor = document.getElementById('bg-color').value;
  const textColor = document.getElementById('text-color').value;
  const fontSize = document.getElementById('font-size').value;
  const rotation = parseInt(document.getElementById('rotation-speed').value);

  if (!text.trim()) {
    log('WARN', 'Billboard text is required');
    return;
  }

  try {
    log('INFO', 'Creating billboard...');
    
    const res = await fetch('/run/billboard', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'create',
        text,
        bgColor,
        textColor,
        fontSize,
        rotation,
        imageData: state.generatedImageData,
        template: state.selectedTemplate?.id || 'custom'
      })
    });

    const data = await res.json();
    
    if (data.result) {
      log('SUCCESS', `Billboard #${data.result.id} created successfully`);
      state.currentBillboard = data.result;
      
      // Clear form
      document.getElementById('billboard-text').value = '';
      document.getElementById('image-prompt').value = '';
      state.generatedImageData = null;
      document.getElementById('image-preview-container').style.display = 'none';
      
      // Reload billboards
      await loadBillboards();
      
      // Switch to preview
      updatePreview();
    }
    
  } catch (err) {
    log('ERROR', `Failed to create billboard: ${err.message}`);
  }
}

// ============================================
// AI Message Generation
// ============================================
async function generateMessage() {
  const topic = document.getElementById('ai-topic').value;
  const template = document.getElementById('ai-template').value;

  if (!topic.trim()) {
    log('WARN', 'Please enter a topic for AI generation');
    return;
  }

  try {
    log('INFO', 'Generating AI message...');
    
    const res = await fetch('/run/billboard', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'generateMessage',
        topic,
        template
      })
    });

    const data = await res.json();
    
    if (data.result) {
      document.getElementById('billboard-text').value = data.result.text;
      log('SUCCESS', 'AI message generated successfully');
    }
    
  } catch (err) {
    log('ERROR', `Failed to generate message: ${err.message}`);
  }
}

// ============================================
// Image Generation
// ============================================
async function generateImage() {
  const prompt = document.getElementById('image-prompt').value;

  if (!prompt.trim()) {
    log('WARN', 'Please enter an image description');
    return;
  }

  try {
    log('INFO', 'Generating image with AI...');
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = 'üé® Generating... <span class="spinner"></span>';
    
    const res = await fetch('/run/llm', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'generateImage',
        prompt,
        description: prompt
      })
    });

    const data = await res.json();
    
    if (data.result && data.result.imageBase64) {
      state.generatedImageData = `data:image/png;base64,${data.result.imageBase64}`;
      
      const preview = document.getElementById('generated-image-preview');
      preview.src = state.generatedImageData;
      document.getElementById('image-preview-container').style.display = 'block';
      
      log('SUCCESS', 'Image generated successfully');
    } else {
      log('ERROR', 'Image generation failed - no image data returned');
    }
    
    btn.disabled = false;
    btn.innerHTML = 'üé® Generate Image with AI';
    
  } catch (err) {
    log('ERROR', `Failed to generate image: ${err.message}`);
    event.target.disabled = false;
    event.target.innerHTML = 'üé® Generate Image with AI';
  }
}

// ============================================
// Billboard Management
// ============================================
async function loadBillboards() {
  try {
    const res = await fetch('/run/billboard', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'list' })
    });

    const data = await res.json();
    state.billboards = data.result || [];
    
    // Update stats
    document.getElementById('total-billboards').textContent = state.billboards.length;
    document.getElementById('active-billboards').textContent = state.billboards.filter(b => b.active).length;
    document.getElementById('total-views').textContent = state.billboards.reduce((sum, b) => sum + b.views, 0);
    
    // Render billboard cards
    const list = document.getElementById('billboard-list');
    list.innerHTML = '';
    
    if (state.billboards.length === 0) {
      list.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">No billboards created yet</div>';
      return;
    }
    
    state.billboards.forEach(billboard => {
      const card = document.createElement('div');
      card.className = 'billboard-card';
      card.onclick = () => viewBillboard(billboard.id);
      card.innerHTML = `
        <div class="billboard-card-header">
          <div class="billboard-card-title">Billboard #${billboard.id}</div>
          <div style="font-size: 10px; color: #888;">Views: ${billboard.views}</div>
        </div>
        <div class="billboard-card-preview" style="background: ${billboard.bgColor}; color: ${billboard.textColor};">
          ${billboard.imageData ? `<img src="${billboard.imageData}" class="billboard-card-image">` : ''}
          <div class="billboard-card-text" style="font-size: ${billboard.fontSize}; color: ${billboard.textColor};">
            ${billboard.text}
          </div>
        </div>
        <div class="billboard-card-actions">
          <button class="btn btn-small" onclick="event.stopPropagation(); viewBillboard(${billboard.id})">
            üëÅÔ∏è Preview
          </button>
          <button class="btn btn-small btn-danger" onclick="event.stopPropagation(); deleteBillboard(${billboard.id})">
            üóëÔ∏è Delete
          </button>
        </div>
      `;
      list.appendChild(card);
    });
    
  } catch (err) {
    log('ERROR', `Failed to load billboards: ${err.message}`);
  }
}

async function viewBillboard(id) {
  try {
    const res = await fetch('/run/billboard', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'get', id })
    });

    const data = await res.json();
    state.currentBillboard = data.result;
    
    switchTab('preview');
    updatePreview();
    log('INFO', `Viewing billboard #${id}`);
    
  } catch (err) {
    log('ERROR', `Failed to view billboard: ${err.message}`);
  }
}

async function deleteBillboard(id) {
  if (!confirm('Delete this billboard?')) return;

  try {
    const res = await fetch('/run/billboard', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'delete', id })
    });

    const data = await res.json();
    log('SUCCESS', `Billboard #${id} deleted`);
    await loadBillboards();
    
  } catch (err) {
    log('ERROR', `Failed to delete billboard: ${err.message}`);
  }
}

// ============================================
// Preview Management
// ============================================
function updatePreview() {
  if (!state.currentBillboard) {
    if (state.billboards.length > 0) {
      state.currentBillboard = state.billboards[0];
    } else {
      return;
    }
  }

  const preview = document.getElementById('live-preview');
  const previewText = document.getElementById('preview-text');
  const previewImage = document.getElementById('preview-image');
  
  preview.style.background = state.currentBillboard.bgColor;
  previewText.style.color = state.currentBillboard.textColor;
  previewText.style.fontSize = state.currentBillboard.fontSize;
  previewText.textContent = state.currentBillboard.text;
  
  if (state.currentBillboard.imageData) {
    previewImage.src = state.currentBillboard.imageData;
    previewImage.style.display = 'block';
  } else {
    previewImage.style.display = 'none';
  }
}

// ============================================
// Rotation Management
// ============================================
function toggleRotation() {
  if (state.rotationInterval) {
    stopRotation();
  } else {
    startRotation();
  }
}

function startRotation() {
  if (state.billboards.length === 0) {
    log('WARN', 'No billboards to rotate');
    return;
  }

  log('INFO', 'Starting billboard rotation');
  document.getElementById('rotation-btn-text').textContent = '‚è∏ Stop Rotation';
  document.getElementById('rotation-indicator').style.display = 'block';
  
  state.rotationIndex = 0;
  
  const rotate = () => {
    state.currentBillboard = state.billboards[state.rotationIndex];
    updatePreview();
    
    state.rotationIndex = (state.rotationIndex + 1) % state.billboards.length;
    
    // Countdown
    let countdown = 5;
    const countdownInterval = setInterval(() => {
      document.getElementById('rotation-countdown').textContent = countdown;
      countdown--;
      if (countdown < 0) clearInterval(countdownInterval);
    }, 1000);
  };
  
  rotate();
  state.rotationInterval = setInterval(rotate, 5000);
}

function stopRotation() {
  log('INFO', 'Stopping billboard rotation');
  clearInterval(state.rotationInterval);
  state.rotationInterval = null;
  document.getElementById('rotation-btn-text').textContent = '‚ñ∂ Start Rotation';
  document.getElementById('rotation-indicator').style.display = 'none';
}

// ============================================
// Color Picker Updates
// ============================================
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('bg-color')?.addEventListener('input', (e) => {
    document.getElementById('bg-preview').style.background = e.target.value;
  });

  document.getElementById('text-color')?.addEventListener('input', (e) => {
    document.getElementById('text-preview').style.background = e.target.value;
  });
});

// ============================================
// Initialize Application
// ============================================
async function init() {
  log('INFO', 'Digital Billboard Manager initializing...');
  
  await loadPlugins();
  await loadTemplates();
  await loadBillboards();
  
  log('SUCCESS', 'Application ready');
}

// Start the application
init();
</script>

</body>
</html>
